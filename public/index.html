<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HyprOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        mono: ['JetBrains Mono', 'monospace'],
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        hypr: {
                            bg: '#0f0f0f',
                            surface: '#1a1a1a',
                            surface2: '#252525',
                            border: '#2a2a2a',
                            accent: '#cba6f7',
                            accent2: '#89b4fa',
                            accent3: '#f38ba8',
                            text: '#cdd6f4',
                            muted: '#6c7086',
                            success: '#a6e3a1',
                            warning: '#f9e2af',
                            error: '#f38ba8'
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'bounce-subtle': 'bounceSubtle 2s infinite',
                    },
                    keyframes: {
                        slideIn: {
                            '0%': { transform: 'translateX(100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        bounceSubtle: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-3px)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background: #0f0f0f;
            color: #cdd6f4;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            user-select: none;
            touch-action: none;
        }

        .hypr-blur {
            background: rgba(26, 26, 26, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .hypr-card {
            background: rgba(30, 30, 30, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.2s ease;
        }

        .hypr-card:hover {
            background: rgba(40, 40, 40, 0.8);
            border-color: rgba(203, 166, 247, 0.3);
        }

        .active-glow {
            box-shadow: 0 0 0 2px #cba6f7, 0 0 30px rgba(203, 166, 247, 0.2);
        }

        .workspace {
            transition: all 0.2s ease;
            position: relative;
        }

        .workspace.active {
            background: #cba6f7;
            color: #0f0f0f;
            font-weight: bold;
        }

        .workspace.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: #cba6f7;
            border-radius: 50%;
        }

        .workspace:hover:not(.active) {
            background: rgba(203, 166, 247, 0.15);
        }

        .window-anim {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px) scale(0.95);
                opacity: 0;
            }

            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        .dragging {
            cursor: grabbing !important;
            opacity: 0.9;
        }

        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: #cba6f7;
            cursor: pointer;
            margin-top: -5px;
            box-shadow: 0 0 10px rgba(203, 166, 247, 0.5);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #3a3a3a;
            border-radius: 2px;
        }

        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #cba6f7;
        }

        .toast {
            animation: slideIn 0.3s ease-out;
        }

        .cursor-blink {
            animation: blink 1s step-end infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        .audio-visualizer {
            display: flex;
            align-items: end;
            gap: 2px;
            height: 30px;
        }

        .audio-bar {
            width: 4px;
            background: #cba6f7;
            border-radius: 2px;
            transition: height 0.05s ease;
        }

        iframe {
            border: none;
            width: 100%;
            height: 100%;
            background: white;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .file-item.selected {
            background: rgba(203, 166, 247, 0.2);
        }

        .context-menu {
            position: absolute;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 4px;
            z-index: 10000;
            min-width: 160px;
            backdrop-filter: blur(10px);
        }

        .context-menu-item {
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .context-menu-item:hover {
            background: rgba(203, 166, 247, 0.2);
        }

        .quick-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid transparent;
        }

        .quick-link:hover {
            background: rgba(203, 166, 247, 0.1);
            border-color: rgba(203, 166, 247, 0.3);
        }

        .desktop-icon {
            /* Change position: absolute to use CSS grid snapping */
            position: absolute;
            width: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: transform 0.2s;
            padding: 8px;
            border-radius: 8px;
            z-index: 5;
            /* Snap to 90px grid (80px width + 10px gap) */
            --grid-size: 90px;
        }
        
        .desktop-icon:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .desktop-icon.selected {
            background: rgba(203, 166, 247, 0.3);
            border: 1px solid rgba(203, 166, 247, 0.5);
        }
        
        .desktop-icon.dragging {
            opacity: 0.7;
            z-index: 1000;
            cursor: grabbing;
            transition: none; /* Disable transition while dragging */
        }
        
        .desktop-icon-name {
            font-size: 11px;
            text-align: center;
            color: #cdd6f4;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .code-editor {
            font-family: 'JetBrains Mono', monospace;
            line-height: 1.5;
        }

        /* Resize handle for windows */
        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: se-resize;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .window-anim:hover .resize-handle {
            opacity: 1;
        }
        
        .resize-handle::after {
            content: '';
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 0 0 10px 10px;
            border-color: transparent transparent rgba(203, 166, 247, 0.5) transparent;
        }
        
        /* Edge resize areas */
        .resize-n { cursor: n-resize; position: absolute; top: 0; left: 10px; right: 10px; height: 5px; }
        .resize-s { cursor: s-resize; position: absolute; bottom: 0; left: 10px; right: 10px; height: 5px; }
        .resize-e { cursor: e-resize; position: absolute; right: 0; top: 10px; bottom: 10px; width: 5px; }
        .resize-w { cursor: w-resize; position: absolute; left: 0; top: 10px; bottom: 10px; width: 5px; }
        .resize-ne { cursor: ne-resize; position: absolute; top: 0; right: 0; width: 10px; height: 10px; }
        .resize-nw { cursor: nw-resize; position: absolute; top: 0; left: 0; width: 10px; height: 10px; }
        .resize-se { cursor: se-resize; position: absolute; bottom: 0; right: 0; width: 10px; height: 10px; }
        .resize-sw { cursor: sw-resize; position: absolute; bottom: 0; left: 0; width: 10px; height: 10px; }
    </style>
    <base target="_blank">
</head>

<body class="h-screen w-screen relative bg-hypr-bg">

    <!-- Wallpaper -->
    <div id="wallpaper" class="absolute inset-0 z-0 bg-cover bg-center transition-all duration-700"
        style="background-image: url('https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=2070&auto=format&fit=crop');">
        <div class="absolute inset-0 bg-black/30" id="wallpaper-dim"></div>
    </div>

    <!-- Notification Container -->
    <div id="notifications" class="absolute top-20 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>

    <!-- Context Menu -->
    <div id="context-menu" class="context-menu hidden"></div>

    <!-- Main Layout -->
    <div class="relative z-10 h-full flex flex-col p-2 gap-2">

        <!-- TOP BAR -->
        <header class="hypr-blur rounded-xl px-4 py-2 flex items-center justify-between text-sm font-mono">
            <div class="flex items-center gap-1" id="workspaces">
                <button class="workspace active w-8 h-8 rounded-lg flex items-center justify-center text-xs" data-ws="1" onclick="switchWorkspace(1)">1</button>
                <button class="workspace w-8 h-8 rounded-lg flex items-center justify-center text-xs text-hypr-muted" data-ws="2" onclick="switchWorkspace(2)">2</button>
                <button class="workspace w-8 h-8 rounded-lg flex items-center justify-center text-xs text-hypr-muted" data-ws="3" onclick="switchWorkspace(3)">3</button>
                <button class="workspace w-8 h-8 rounded-lg flex items-center justify-center text-xs text-hypr-muted" data-ws="4" onclick="switchWorkspace(4)">4</button>
                <button class="workspace w-8 h-8 rounded-lg flex items-center justify-center text-xs text-hypr-muted" data-ws="5" onclick="switchWorkspace(5)">5</button>
                <div class="w-px h-4 bg-white/10 mx-2"></div>
                <span id="active-window-indicator" class="text-hypr-accent text-xs opacity-0 transition-opacity">
                    <i class="fas fa-terminal mr-1"></i><span id="window-title-text">kitty</span>
                </span>
            </div>

            <!-- Center: Search Bar -->
            <div class="absolute left-1/2 transform -translate-x-1/2 w-96">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-hypr-muted text-xs"></i>
                    <input type="text" id="global-search"
                           class="w-full bg-hypr-surface/50 border border-hypr-border rounded-lg py-1.5 pl-9 pr-20 text-sm focus:border-hypr-accent focus:outline-none transition-colors"
                           placeholder="Search files, apps, web..." autocomplete="off">
                    <div class="absolute right-2 top-1/2 transform -translate-y-1/2 flex gap-1">
                        <button onclick="searchWeb()" class="text-xs text-hypr-muted hover:text-hypr-accent px-2 py-0.5 rounded hover:bg-white/5">Web</button>
                        <button onclick="searchFiles()" class="text-xs text-hypr-muted hover:text-hypr-accent px-2 py-0.5 rounded hover:bg-white/5">Files</button>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-3 text-hypr-muted">
                <button onclick="toggleNetwork()" class="hover:text-hypr-text transition-colors p-1 rounded hover:bg-white/5" title="Network">
                    <i class="fas fa-wifi" id="wifi-icon"></i>
                </button>
                <button onclick="toggleBluetooth()" class="hover:text-hypr-accent transition-colors p-1 rounded hover:bg-white/5" title="Bluetooth">
                    <i class="fab fa-bluetooth-b" id="bt-icon"></i>
                </button>
                <div class="flex items-center gap-1 hover:text-hypr-text cursor-pointer p-1 rounded hover:bg-white/5"
                    onclick="toggleBattery()">
                    <i class="fas fa-battery-three-quarters text-hypr-success" id="battery-icon"></i>
                    <span class="text-xs" id="battery-text">--%</span>
                </div>
                <div class="flex items-center gap-1 hover:text-hypr-text cursor-pointer p-1 rounded hover:bg-white/5"
                    onclick="toggleVolume()">
                    <i class="fas fa-volume-high" id="volume-icon"></i>
                    <span class="text-xs" id="volume-level">--</span>
                </div>
                <div class="flex items-center gap-1 hover:text-hypr-text cursor-pointer p-1 rounded hover:bg-white/5"
                    title="CPU Usage">
                    <i class="fas fa-microchip" id="cpu-icon"></i>
                    <span class="text-xs" id="cpu-text">--%</span>
                </div>
                <div class="w-px h-4 bg-white/10"></div>
                <button onclick="toggleSettings()" class="hover:text-hypr-accent transition-colors p-1 rounded hover:bg-white/5">
                    <i class="fas fa-cog"></i>
                </button>
                <button onclick="showPowerMenu()" class="hover:text-hypr-error transition-colors p-1 rounded hover:bg-white/5">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </header>

        <!-- CENTER: Desktop Area -->
        <main class="flex-grow relative overflow-hidden" id="desktop-area">

            <!-- Desktop Icons Container -->
            <div id="desktop-icons" class="absolute inset-0"></div>

            <!-- Launcher -->
            <div id="launcher"
                class="absolute inset-0 flex items-center justify-center z-20 bg-black/40 backdrop-blur-sm"
                style="display: none;">
                <div
                    class="hypr-blur rounded-2xl w-full max-w-3xl window-anim overflow-hidden flex flex-col max-h-[80vh]">
                    <div class="p-4 border-b border-white/10">
                        <div class="relative">
                            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-hypr-muted"></i>
                            <input type="text" id="launcher-search"
                                   class="w-full bg-transparent border-none text-xl focus:ring-0 outline-none pl-12 pr-4 py-2 text-hypr-text placeholder-hypr-muted"
                                   placeholder="Type to search..." autocomplete="off" oninput="filterApps(this.value)">
                            <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-xs text-hypr-muted bg-white/5 px-2 py-1 rounded">ESC to close</span>
                        </div>
                    </div>
                    <div class="flex flex-1 overflow-hidden">
                        <div class="w-64 border-r border-white/10 p-4 overflow-auto">
                            <div class="text-xs font-bold text-hypr-muted uppercase mb-3">Quick Links</div>
                            <div class="space-y-1" id="quick-links-list"></div>
                            <button onclick="manageQuickLinks()" class="mt-3 w-full py-2 text-xs text-hypr-accent hover:bg-white/5 rounded-lg">
                                <i class="fas fa-cog mr-1"></i> Manage Links
                            </button>
                        </div>
                        <div class="flex-1 p-4 overflow-auto">
                            <div class="text-xs font-bold text-hypr-muted uppercase mb-3">Applications</div>
                            <div class="grid grid-cols-4 gap-3" id="apps-grid"></div>
                            <div class="mt-4 pt-4 border-t border-white/10">
                                <div class="text-xs font-bold text-hypr-muted uppercase mb-2">Recent Files</div>
                                <div class="space-y-1" id="recent-files"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Active Windows Container -->
            <div id="windows-container" class="absolute inset-0 pointer-events-none"></div>

        </main>

        <!-- BOTTOM: Dock -->
        <footer class="flex justify-center pb-2">
            <div class="hypr-blur rounded-2xl px-4 py-2 flex items-center gap-2">
                <button onclick="toggleLauncher()" class="p-2 rounded-xl hover:bg-white/10 transition-all hover:scale-110 group">
                    <i class="fas fa-th text-xl text-hypr-accent group-hover:rotate-12 transition-transform"></i>
                </button>
                <div class="w-px h-6 bg-white/10 mx-1"></div>
                <button onclick="openApp('files')" class="p-2 rounded-xl hover:bg-white/10 transition-all hover:scale-110 hover:-translate-y-1">
                    <i class="fas fa-folder text-2xl text-yellow-400"></i>
                </button>
                <button onclick="openApp('browser')" class="p-2 rounded-xl hover:bg-white/10 transition-all hover:scale-110 hover:-translate-y-1">
                    <i class="fab fa-firefox text-2xl text-orange-500"></i>
                </button>
                <button onclick="openApp('terminal')" class="p-2 rounded-xl hover:bg-white/10 transition-all hover:scale-110 hover:-translate-y-1">
                    <i class="fas fa-terminal text-2xl text-green-400"></i>
                </button>
                <button onclick="openApp('code')" class="p-2 rounded-xl hover:bg-white/10 transition-all hover:scale-110 hover:-translate-y-1">
                    <i class="fas fa-code text-2xl text-blue-400"></i>
                </button>
                <button onclick="openApp('music')" class="p-2 rounded-xl hover:bg-white/10 transition-all hover:scale-110 hover:-translate-y-1">
                    <i class="fas fa-music text-2xl text-pink-400"></i>
                </button>
                <button onclick="openApp('calculator')" class="p-2 rounded-xl hover:bg-white/10 transition-all hover:scale-110 hover:-translate-y-1">
                    <i class="fas fa-calculator text-2xl text-cyan-400"></i>
                </button>
                <button onclick="openApp('paint')" class="p-2 rounded-xl hover:bg-white/10 transition-all hover:scale-110 hover:-translate-y-1">
                    <i class="fas fa-paint-brush text-2xl text-purple-400"></i>
                </button>
                <button onclick="openApp('taskmanager')" class="p-2 rounded-xl hover:bg-white/10 transition-all hover:scale-110 hover:-translate-y-1">
                    <i class="fas fa-tasks text-2xl text-red-400"></i>
                </button>
                <button onclick="openApp('appcreator')" class="p-2 rounded-xl hover:bg-white/10 transition-all hover:scale-110 hover:-translate-y-1">
                    <i class="fas fa-plus-circle text-2xl text-green-500"></i>
                </button>
                <div class="w-px h-6 bg-white/10 mx-1"></div>
                <button onclick="toggleSettings()" class="p-2 rounded-xl hover:bg-white/10 transition-all hover:scale-110 hover:rotate-90">
                    <i class="fas fa-cog text-xl text-hypr-muted"></i>
                </button>
            </div>
        </footer>
    </div>

    <!-- SETTINGS WINDOW -->
    <div id="settings-window"
        class="hidden absolute top-16 right-4 w-96 hypr-blur rounded-xl shadow-2xl z-50 window-anim flex flex-col max-h-[85vh]">
        <div class="h-12 border-b border-white/10 flex items-center justify-between px-4 cursor-grab bg-white/5"
            id="settings-header">
            <span class="font-bold text-sm flex items-center gap-2">
                <i class="fas fa-sliders-h text-hypr-accent"></i> Settings
            </span>
            <button onclick="toggleSettings()" class="text-hypr-muted hover:text-white transition-colors w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/10">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="p-4 overflow-y-auto space-y-4 text-sm">
            <section class="space-y-3">
                <h3 class="text-xs font-bold text-hypr-muted uppercase tracking-wider">System Data</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="exportFileSystem()" class="p-2 bg-hypr-surface/50 rounded-lg hover:bg-hypr-accent/20 transition-colors text-xs flex items-center justify-center gap-2">
                        <i class="fas fa-download"></i> Export FS
                    </button>
                    <button onclick="importFileSystem()" class="p-2 bg-hypr-surface/50 rounded-lg hover:bg-hypr-accent/20 transition-colors text-xs flex items-center justify-center gap-2">
                        <i class="fas fa-upload"></i> Import FS
                    </button>
                </div>
                <input type="file" id="fs-import-input" class="hidden" accept=".json" onchange="handleFSImport(this)">
            </section>

            <section class="space-y-3">
                <h3 class="text-xs font-bold text-hypr-muted uppercase tracking-wider">Quick Links</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="exportQuickLinks()" class="p-2 bg-hypr-surface/50 rounded-lg hover:bg-hypr-accent2/20 transition-colors text-xs flex items-center justify-center gap-2">
                        <i class="fas fa-download"></i> Export Links
                    </button>
                    <button onclick="importQuickLinks()" class="p-2 bg-hypr-surface/50 rounded-lg hover:bg-hypr-accent2/20 transition-colors text-xs flex items-center justify-center gap-2">
                        <i class="fas fa-upload"></i> Import Links
                    </button>
                </div>
                <input type="file" id="ql-import-input" class="hidden" accept=".json" onchange="handleQLImport(this)">
            </section>

            <section class="space-y-3">
                <h3 class="text-xs font-bold text-hypr-muted uppercase tracking-wider">Custom Apps</h3>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="exportCustomApps()" class="p-2 bg-hypr-surface/50 rounded-lg hover:bg-hypr-accent3/20 transition-colors text-xs flex items-center justify-center gap-2">
                        <i class="fas fa-download"></i> Export Apps
                    </button>
                    <button onclick="importCustomApps()" class="p-2 bg-hypr-surface/50 rounded-lg hover:bg-hypr-accent3/20 transition-colors text-xs flex items-center justify-center gap-2">
                        <i class="fas fa-upload"></i> Import Apps
                    </button>
                </div>
                <input type="file" id="ca-import-input" class="hidden" accept=".json" onchange="handleCAImport(this)">
            </section>

            <section class="space-y-3">
                <h3 class="text-xs font-bold text-hypr-muted uppercase tracking-wider">Wallpaper</h3>
                <div class="flex gap-2">
                    <input type="text" id="wallpaper-input" class="flex-1 bg-hypr-surface border border-hypr-border rounded-lg px-3 py-2 text-xs focus:border-hypr-accent outline-none" placeholder="Image URL...">
                    <button onclick="applyWallpaper()" class="bg-hypr-accent text-hypr-bg px-3 py-2 rounded-lg text-xs font-bold hover:opacity-90">
                        <i class="fas fa-check"></i>
                    </button>
                </div>
                <div
                    class="border-2 border-dashed border-hypr-border rounded-lg p-3 text-center hover:border-hypr-accent transition-colors cursor-pointer relative">
                    <input type="file" id="wallpaper-file" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileUpload(this)">
                    <i class="fas fa-cloud-upload-alt text-hypr-muted"></i>
                    <p class="text-xs text-hypr-muted mt-1">Upload image</p>
                </div>
            </section>

            <section class="space-y-3">
                <h3 class="text-xs font-bold text-hypr-muted uppercase tracking-wider">Appearance</h3>
                <div class="flex items-center justify-between p-2 bg-hypr-surface/50 rounded-lg">
                    <span>Border Glow</span>
                    <button onclick="toggleGlow()" id="glow-toggle-btn" class="w-10 h-5 rounded-full bg-hypr-accent relative transition-colors">
                        <div class="w-3 h-3 bg-white rounded-full absolute top-1 right-1 transition-all"></div>
                    </button>
                </div>
            </section>

            <section class="space-y-3">
                <h3 class="text-xs font-bold text-hypr-muted uppercase tracking-wider">System</h3>
                <div class="space-y-2">
                    <div class="flex items-center justify-between p-2 bg-hypr-surface/50 rounded-lg">
                        <div class="flex items-center gap-2">
                            <i class="fas fa-volume-up text-hypr-accent"></i>
                            <span>Volume</span>
                        </div>
                        <span id="volume-display" class="text-xs text-hypr-muted">75%</span>
                    </div>
                    <input type="range" min="0" max="100" value="75" class="w-full" oninput="updateVolume(this.value)">
                </div>
            </section>

            <button onclick="resetAll()" class="w-full py-2 border border-hypr-error/30 text-hypr-error rounded-lg text-xs hover:bg-hypr-error/10 transition-colors">
                <i class="fas fa-trash-alt mr-2"></i> Reset System
            </button>
        </div>
    </div>

    <!-- POWER MENU -->
    <div id="power-menu"
        class="hidden absolute inset-0 z-50 bg-black/60 backdrop-blur-md flex items-center justify-center">
        <div class="hypr-blur rounded-2xl p-8 flex gap-6 window-anim">
            <button onclick="sleepSystem()" class="flex flex-col items-center gap-3 p-6 rounded-xl hover:bg-white/10 transition-all hover:scale-110 group">
                <i class="fas fa-moon text-3xl text-hypr-accent2 group-hover:animate-bounce"></i>
                <span class="text-sm">Sleep</span>
            </button>
            <button onclick="restartSystem()" class="flex flex-col items-center gap-3 p-6 rounded-xl hover:bg-white/10 transition-all hover:scale-110 group">
                <i class="fas fa-redo text-3xl text-hypr-warning group-hover:animate-spin"></i>
                <span class="text-sm">Restart</span>
            </button>
            <button onclick="shutdownSystem()" class="flex flex-col items-center gap-3 p-6 rounded-xl hover:bg-white/10 transition-all hover:scale-110 group">
                <i class="fas fa-power-off text-3xl text-hypr-error group-hover:animate-pulse"></i>
                <span class="text-sm">Shut Down</span>
            </button>
            <button onclick="hidePowerMenu()" class="flex flex-col items-center gap-3 p-6 rounded-xl hover:bg-white/10 transition-all hover:scale-110">
                <i class="fas fa-times text-3xl text-hypr-muted"></i>
                <span class="text-sm">Cancel</span>
            </button>
        </div>
    </div>

    <script>
        // File System
        let fileSystem = {
            root: {
                type: 'folder',
                children: {
                    'Home': {
                        type: 'folder',
                        children: {
                            'Documents': {
                                type: 'folder',
                                children: {
                                    'welcome.txt': { type: 'file', content: 'Welcome to HyprOS!\n\nThis is your personal file system.\nYou can create, edit, and delete files.\n\nTry opening the Text Editor to create new files.', lastModified: Date.now() },
                                    'todo.txt': { type: 'file', content: '- [ ] Explore the system\n- [ ] Create some files\n- [ ] Customize desktop', lastModified: Date.now() }
                                }
                            },
                            'Pictures': { type: 'folder', children: {} },
                            'Music': { type: 'folder', children: {} },
                            'Downloads': { type: 'folder', children: {} }
                        }
                    }
                }
            },
            trash: {}
        };

        let quickLinks = [
            { name: 'Google', url: 'https://google.com', icon: 'fa-google', color: 'text-blue-400' },
            { name: 'GitHub', url: 'https://github.com', icon: 'fa-github', color: 'text-white' },
            { name: 'YouTube', url: 'https://youtube.com', icon: 'fa-youtube', color: 'text-red-400' },
            { name: 'Reddit', url: 'https://reddit.com', icon: 'fa-reddit', color: 'text-orange-400' }
        ];

        let customApps = [];

        let desktopIcons = [
            { id: 'home', name: 'Home', icon: 'fa-folder', color: 'text-yellow-400', x: 20, y: 20, path: ['Home'] },
            { id: 'docs', name: 'Documents', icon: 'fa-file-alt', color: 'text-blue-400', x: 20, y: 120, path: ['Home', 'Documents'] },
            { id: 'trash', name: 'Trash', icon: 'fa-trash', color: 'text-gray-400', x: 20, y: 220, path: null, isTrash: true }
        ];

        let state = {
            wallpaper: 'https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=2070&auto=format&fit=crop',
            volume: 75,
            glow: true,
            activeWorkspace: 1,
            windows: [],
            musicFiles: [],
            selectedFiles: new Set(),
            clipboard: null
        };

        const defaultApps = [
            { id: 'terminal', name: 'Terminal', icon: 'fa-terminal', color: 'text-green-400' },
            { id: 'files', name: 'Files', icon: 'fa-folder', color: 'text-yellow-400' },
            { id: 'browser', name: 'Browser', icon: 'fa-firefox', color: 'text-orange-500' },
            { id: 'code', name: 'Code Editor', icon: 'fa-code', color: 'text-blue-400' },
            { id: 'music', name: 'Music', icon: 'fa-music', color: 'text-pink-400' },
            { id: 'calculator', name: 'Calculator', icon: 'fa-calculator', color: 'text-cyan-400' },
            { id: 'paint', name: 'Paint', icon: 'fa-paint-brush', color: 'text-purple-400' },
            { id: 'settings', name: 'Settings', icon: 'fa-cog', color: 'text-hypr-accent' },
            { id: 'taskmanager', name: 'Task Manager', icon: 'fa-tasks', color: 'text-red-400' },
            { id: 'appcreator', name: 'App Creator', icon: 'fa-plus-circle', color: 'text-green-500' },
        ];

        let apps = [...defaultApps];

        const recentFiles = [
            { name: 'project.py', icon: 'fa-file-code', color: 'text-blue-400', path: '~/dev' },
            { name: 'notes.md', icon: 'fa-file-alt', color: 'text-white', path: '~/docs' },
            { name: 'screenshot.png', icon: 'fa-image', color: 'text-green-400', path: '~/pics' },
        ];

        const els = {
            wallpaper: document.getElementById('wallpaper'),
            wallpaperDim: document.getElementById('wallpaper-dim'),
            launcher: document.getElementById('launcher'),
            appsGrid: document.getElementById('apps-grid'),
            quickLinksList: document.getElementById('quick-links-list'),
            recentFiles: document.getElementById('recent-files'),
            windowsContainer: document.getElementById('windows-container'),
            settingsWindow: document.getElementById('settings-window'),
            settingsHeader: document.getElementById('settings-header'),
            notifications: document.getElementById('notifications'),
            activeWindowIndicator: document.getElementById('active-window-indicator'),
            windowTitleText: document.getElementById('window-title-text'),
            powerMenu: document.getElementById('power-menu'),
            desktopIcons: document.getElementById('desktop-icons'),
            contextMenu: document.getElementById('context-menu'),
            globalSearch: document.getElementById('global-search')
        };

        // Initialize
        function init() {
            loadState();
            updateAppsList();
            renderDesktopIcons();
            renderApps();
            renderQuickLinks();
            updateSystemInfo();
            setInterval(updateSystemInfo, 2000);
            setupGlobalEvents();
            setupSearchBar();
        }

        function updateAppsList() {
            apps = [...defaultApps, ...customApps.map((app, idx) => ({
                id: `custom_${idx}`,
                name: app.name,
                icon: app.icon,
                color: app.color,
                isCustom: true,
                customIndex: idx
            }))];
        }

        function setupSearchBar() {
            els.globalSearch.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const query = els.globalSearch.value.trim();
                    if (!query) return;
                    
                    if (query.includes('.') && !query.includes(' ')) {
                        let url = query;
                        if (!url.startsWith('http')) {
                            url = 'https://' + url;
                        }
                        openApp('browser');
                        setTimeout(() => {
                            const browserWin = state.windows.find(w => w.app.id === 'browser');
                            if (browserWin) {
                                const urlInput = document.getElementById(`url-${browserWin.id}`);
                                const iframe = document.getElementById(`iframe-${browserWin.id}`);
                                if (urlInput && iframe) {
                                    urlInput.value = url;
                                    iframe.src = url;
                                }
                            }
                        }, 100);
                    } else {
                        searchWeb();
                    }
                    els.globalSearch.value = '';
                }
            });
        }

        function loadState() {
            const saved = localStorage.getItem('hypros_complete');
            if (saved) {
                const data = JSON.parse(saved);
                fileSystem = data.fileSystem || fileSystem;
                quickLinks = data.quickLinks || quickLinks;
                desktopIcons = data.desktopIcons || desktopIcons;
                customApps = data.customApps || [];
                state.wallpaper = data.wallpaper || state.wallpaper;
                state.volume = data.volume || 75;
                state.glow = data.glow !== undefined ? data.glow : true;
                
                updateAppsList();
                els.wallpaper.style.backgroundImage = `url('${state.wallpaper}')`;
            }
            loadMusicFromFS();
            loadPicturesFromFS();
        }

        function saveState() {
            localStorage.setItem('hypros_complete', JSON.stringify({
                fileSystem,
                quickLinks,
                desktopIcons,
                customApps,
                wallpaper: state.wallpaper,
                volume: state.volume,
                glow: state.glow
            }));
        }

        function loadMusicFromFS() {
            const musicFolder = getFolder(['Home', 'Music']);
            if (musicFolder && musicFolder.children) {
                state.musicFiles = Object.entries(musicFolder.children).map(([name, item]) => ({
                    name: name.replace(/\.[^/.]+$/, ""),
                    artist: "Unknown",
                    url: item.content,
                    file: { name: name }
                }));
            }
        }

        function loadPicturesFromFS() {
            // Pictures are loaded on demand when paint app opens
        }

        // Desktop Icons - FIXED
        function renderDesktopIcons() {
            els.desktopIcons.innerHTML = '';
            desktopIcons.forEach(icon => {
                const iconEl = document.createElement('div');
                iconEl.className = 'desktop-icon';
                iconEl.id = `desktop-icon-${icon.id}`;
                iconEl.style.left = icon.x + 'px';
                iconEl.style.top = icon.y + 'px';
                
                iconEl.innerHTML = `
                    <i class="fas ${icon.icon} text-4xl ${icon.color} drop-shadow-lg"></i>
                    <span class="desktop-icon-name">${icon.name}</span>
                `;
                
                iconEl.addEventListener('mousedown', (e) => handleIconMouseDown(e, icon.id));
                iconEl.addEventListener('click', (e) => handleIconClick(e, icon.id));
                iconEl.addEventListener('dblclick', (e) => handleIconDoubleClick(e, icon.id));
                iconEl.addEventListener('contextmenu', (e) => showIconContextMenu(e, icon.id));
                
                iconEl.addEventListener('touchstart', (e) => handleIconTouchStart(e, icon.id), { passive: false });
                iconEl.addEventListener('touchmove', (e) => handleIconTouchMove(e, icon.id), { passive: false });
                iconEl.addEventListener('touchend', (e) => handleIconTouchEnd(e, icon.id));
                
                els.desktopIcons.appendChild(iconEl);
            });
        }

        let draggedIconId = null;
        let iconDragOffset = { x: 0, y: 0 };
        let iconTouchStartTime = 0;
        let iconTouchMoved = false;

        function handleIconMouseDown(e, iconId) {
            if (e.button !== 0) return;
            e.stopPropagation();
            
            const icon = desktopIcons.find(i => i.id === iconId);
            iconDragOffset.x = e.clientX - icon.x;
            iconDragOffset.y = e.clientY - icon.y;
            draggedIconId = iconId;
            
            document.getElementById(`desktop-icon-${iconId}`).classList.add('dragging');
            
            document.addEventListener('mousemove', handleIconMouseMove);
            document.addEventListener('mouseup', handleIconMouseUp);
        }

        function handleIconMouseMove(e) {
            if (!draggedIconId) return;
            
            const icon = desktopIcons.find(i => i.id === draggedIconId);
            const gridSize = 90; // Match the CSS variable
            
            // Calculate raw position
            let rawX = Math.max(0, Math.min(window.innerWidth - 100, e.clientX - iconDragOffset.x));
            let rawY = Math.max(50, Math.min(window.innerHeight - 150, e.clientY - iconDragOffset.y));
            
            // Snap to grid
            icon.x = Math.round(rawX / gridSize) * gridSize;
            icon.y = Math.round(rawY / gridSize) * gridSize;
            
            const el = document.getElementById(`desktop-icon-${draggedIconId}`);
            el.style.left = icon.x + 'px';
            el.style.top = icon.y + 'px';
        }

        function handleIconMouseUp(e) {
            if (draggedIconId) {
                document.getElementById(`desktop-icon-${draggedIconId}`).classList.remove('dragging');
                draggedIconId = null;
                saveState();
            }
            document.removeEventListener('mousemove', handleIconMouseMove);
            document.removeEventListener('mouseup', handleIconMouseUp);
        }

        function handleIconTouchStart(e, iconId) {
            e.stopPropagation();
            iconTouchStartTime = Date.now();
            iconTouchMoved = false;
            
            const touch = e.touches[0];
            const icon = desktopIcons.find(i => i.id === iconId);
            iconDragOffset.x = touch.clientX - icon.x;
            iconDragOffset.y = touch.clientY - icon.y;
            draggedIconId = iconId;
        }

        function handleIconTouchMove(e) {
            if (!draggedIconId) return;
            e.preventDefault();
            iconTouchMoved = true;
            
            const touch = e.touches[0];
            const icon = desktopIcons.find(i => i.id === draggedIconId);
            const gridSize = 90;
            
            let rawX = Math.max(0, Math.min(window.innerWidth - 100, touch.clientX - iconDragOffset.x));
            let rawY = Math.max(50, Math.min(window.innerHeight - 150, touch.clientY - iconDragOffset.y));
            
            icon.x = Math.round(rawX / gridSize) * gridSize;
            icon.y = Math.round(rawY / gridSize) * gridSize;
            
            const el = document.getElementById(`desktop-icon-${draggedIconId}`);
            el.style.left = icon.x + 'px';
            el.style.top = icon.y + 'px';
        }

        function handleIconTouchEnd(e) {
            if (draggedIconId) {
                const touchDuration = Date.now() - iconTouchStartTime;
                
                if (!iconTouchMoved && touchDuration < 300) {
                    handleIconDoubleClick(e, draggedIconId);
                }
                
                draggedIconId = null;
                saveState();
            }
        }

        function handleIconClick(e, iconId) {
            document.querySelectorAll('.desktop-icon').forEach(el => el.classList.remove('selected'));
            document.getElementById(`desktop-icon-${iconId}`).classList.add('selected');
        }

        function handleIconDoubleClick(e, iconId) {
            e.stopPropagation();
            const icon = desktopIcons.find(i => i.id === iconId);
            
            if (icon.isTrash) {
                openApp('trash');
            } else if (icon.path) {
                openApp('files', icon.path);
            }
        }

        function showIconContextMenu(e, iconId) {
            e.preventDefault();
            e.stopPropagation();
            
            const icon = desktopIcons.find(i => i.id === iconId);
            
            showContextMenu(e.clientX, e.clientY, [
                { label: 'Open', icon: 'fa-folder-open', action: () => handleIconDoubleClick(e, iconId) },
                { label: icon.isTrash ? 'Empty Trash' : 'Rename', icon: 'fa-edit', action: () => renameDesktopIcon(iconId) },
                !icon.isTrash && { label: 'Delete', icon: 'fa-trash', action: () => deleteDesktopIcon(iconId) }
            ].filter(Boolean));
        }

        function renameDesktopIcon(iconId) {
            const icon = desktopIcons.find(i => i.id === iconId);
            const newName = prompt('New name:', icon.name);
            if (newName) {
                icon.name = newName;
                renderDesktopIcons();
                saveState();
            }
        }

        function deleteDesktopIcon(iconId) {
            const index = desktopIcons.findIndex(i => i.id === iconId);
            if (index > -1) {
                desktopIcons.splice(index, 1);
                renderDesktopIcons();
                saveState();
                showNotification('Desktop', 'Icon removed', 'fa-trash');
            }
        }

        // File System Operations
        function getFolder(path) {
            let current = fileSystem.root;
            for (const segment of path) {
                if (current.children && current.children[segment]) {
                    current = current.children[segment];
                } else {
                    return null;
                }
            }
            return current;
        }

        function createFile(path, name, content = '') {
            const folder = getFolder(path);
            if (folder && folder.children) {
                folder.children[name] = {
                    type: 'file',
                    content: content,
                    lastModified: Date.now()
                };
                saveState();
                return true;
            }
            return false;
        }

        function createFolder(path, name) {
            const folder = getFolder(path);
            if (folder && folder.children) {
                folder.children[name] = {
                    type: 'folder',
                    children: {}
                };
                saveState();
                return true;
            }
            return false;
        }

        function moveToTrash(path, name) {
            const folder = getFolder(path);
            if (folder && folder.children && folder.children[name]) {
                fileSystem.trash[name + '_' + Date.now()] = folder.children[name];
                delete folder.children[name];
                saveState();
                return true;
            }
            return false;
        }

        function restoreFromTrash(name) {
            if (fileSystem.trash[name]) {
                fileSystem.root.children['Home'].children[name] = fileSystem.trash[name];
                delete fileSystem.trash[name];
                saveState();
                return true;
            }
            return false;
        }

        function emptyTrash() {
            fileSystem.trash = {};
            saveState();
            showNotification('Trash', 'Trash emptied', 'fa-trash');
        }

        // Export/Import
        function exportFileSystem() {
            const data = JSON.stringify(fileSystem, null, 2);
            downloadFile('filesystem.json', data, 'application/json');
            showNotification('Export', 'File system exported', 'fa-download');
        }

        function importFileSystem() {
            document.getElementById('fs-import-input').click();
        }

        function handleFSImport(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        fileSystem = JSON.parse(e.target.result);
                        saveState();
                        showNotification('Import', 'File system imported successfully', 'fa-check');
                        state.windows.forEach(w => {
                            if (w.app.id === 'files') refreshFileWindow(w.id);
                        });
                    } catch (err) {
                        showNotification('Error', 'Invalid file system format', 'fa-exclamation');
                    }
                };
                reader.readAsText(file);
            }
        }

        function exportQuickLinks() {
            const data = JSON.stringify(quickLinks, null, 2);
            downloadFile('quicklinks.json', data, 'application/json');
            showNotification('Export', 'Quick links exported', 'fa-download');
        }

        function importQuickLinks() {
            document.getElementById('ql-import-input').click();
        }

        function handleQLImport(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        quickLinks = JSON.parse(e.target.result);
                        saveState();
                        renderQuickLinks();
                        showNotification('Import', 'Quick links imported successfully', 'fa-check');
                    } catch (err) {
                        showNotification('Error', 'Invalid quick links format', 'fa-exclamation');
                    }
                };
                reader.readAsText(file);
            }
        }

        function exportCustomApps() {
            const data = JSON.stringify(customApps, null, 2);
            downloadFile('customapps.json', data, 'application/json');
            showNotification('Export', 'Custom apps exported', 'fa-download');
        }

        function importCustomApps() {
            document.getElementById('ca-import-input').click();
        }

        function handleCAImport(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        customApps = JSON.parse(e.target.result);
                        updateAppsList();
                        renderApps();
                        saveState();
                        showNotification('Import', 'Custom apps imported successfully', 'fa-check');
                    } catch (err) {
                        showNotification('Error', 'Invalid custom apps format', 'fa-exclamation');
                    }
                };
                reader.readAsText(file);
            }
        }

        function downloadFile(filename, content, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Apps
        function renderApps(filter = '') {
            const filtered = apps.filter(app => app.name.toLowerCase().includes(filter.toLowerCase()));
            els.appsGrid.innerHTML = filtered.map(app => `
                <button onclick="openApp('${app.id}'); toggleLauncher()" 
                        class="hypr-card rounded-xl p-3 flex flex-col items-center gap-2 hover:scale-105 transition-transform group">
                    <div class="w-12 h-12 rounded-lg bg-hypr-surface flex items-center justify-center ${app.color} group-hover:brightness-125">
                        <i class="fas ${app.icon} text-xl"></i>
                    </div>
                    <span class="text-xs text-center text-hypr-muted group-hover:text-hypr-text">${app.name}</span>
                </button>
            `).join('');
        }

        function renderQuickLinks() {
            els.quickLinksList.innerHTML = quickLinks.map((link, i) => `
                <div class="quick-link group" onclick="openURL('${link.url}')">
                    <i class="fab ${link.icon} ${link.color} w-5"></i>
                    <span class="text-sm flex-1">${link.name}</span>
                    <button onclick="event.stopPropagation(); editQuickLink(${i})" class="text-hypr-muted hover:text-hypr-text opacity-0 group-hover:opacity-100">
                        <i class="fas fa-edit text-xs"></i>
                    </button>
                </div>
            `).join('');
        }

        function manageQuickLinks() {
            const name = prompt('Link name:');
            if (!name) return;
            const url = prompt('URL:');
            if (!url) return;
            const icon = prompt('FontAwesome icon class (e.g., fa-google):', 'fa-link') || 'fa-link';
            const color = prompt('Color class (e.g., text-blue-400):', 'text-hypr-accent') || 'text-hypr-accent';
            
            quickLinks.push({ name, url, icon, color });
            saveState();
            renderQuickLinks();
            showNotification('Quick Links', 'Link added', 'fa-plus');
        }

        function editQuickLink(index) {
            const link = quickLinks[index];
            const action = prompt('Action: (delete/edit)', 'edit');
            if (action === 'delete') {
                quickLinks.splice(index, 1);
                saveState();
                renderQuickLinks();
            } else if (action === 'edit') {
                link.name = prompt('Name:', link.name) || link.name;
                link.url = prompt('URL:', link.url) || link.url;
                saveState();
                renderQuickLinks();
            }
        }

        function openURL(url) {
            if (!url.startsWith('http')) url = 'https://' + url;
            window.open(url, '_blank');
        }

        function getRandomPosition() {
            const maxX = Math.max(50, window.innerWidth - 850);
            const maxY = Math.max(100, window.innerHeight - 650);
            return {
                x: Math.floor(Math.random() * maxX) + 50,
                y: Math.floor(Math.random() * maxY) + 80
            };
        }

        function openApp(appId, path = null) {
            let app;
            if (appId.startsWith('custom_')) {
                const idx = parseInt(appId.split('_')[1]);
                const customApp = customApps[idx];
                app = { 
                    id: appId, 
                    name: customApp.name, 
                    icon: customApp.icon, 
                    color: customApp.color,
                    isCustom: true,
                    customIndex: idx
                };
            } else {
                app = apps.find(a => a.id === appId) || { id: appId, name: appId, icon: 'fa-window-maximize', color: 'text-hypr-text' };
            }
            
            const windowId = 'win-' + Date.now();
            const pos = getRandomPosition();
            
            const windowEl = document.createElement('div');
            windowEl.id = windowId;
            windowEl.className = 'absolute hypr-blur rounded-xl flex flex-col shadow-2xl window-anim pointer-events-auto';
            windowEl.style.width = '800px';
            windowEl.style.height = '600px';
            windowEl.style.left = pos.x + 'px';
            windowEl.style.top = pos.y + 'px';
            if (state.glow) windowEl.classList.add('active-glow');

            let content = generateAppContent(appId, windowId, path, app);

                windowEl.innerHTML = `
                    <div class="h-10 border-b border-white/10 flex items-center justify-between px-3 bg-white/5 rounded-t-xl touch-none" 
                         onmousedown="startDrag(event, '${windowId}')" 
                         ontouchstart="startDrag(event, '${windowId}')">
                        <div class="flex items-center gap-2 pointer-events-none">
                            <i class="fas ${app.icon} ${app.color} text-xs"></i>
                            <span class="text-xs font-mono text-hypr-muted" id="title-${windowId}">${app.name}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="minimizeWindow('${windowId}')" class="w-3 h-3 rounded-full bg-yellow-500/80 hover:bg-yellow-400 transition-colors"></button>
                            <button onclick="maximizeWindow('${windowId}')" class="w-3 h-3 rounded-full bg-green-500/80 hover:bg-green-400 transition-colors"></button>
                            <button onclick="closeWindow('${windowId}')" class="w-3 h-3 rounded-full bg-red-500/80 hover:bg-red-400 transition-colors"></button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-hidden rounded-b-xl relative" id="content-${windowId}">
                        ${content}
                    </div>
                    <!-- Resize handles -->
                    <div class="resize-n" onmousedown="startResize(event, '${windowId}', 'n')" ontouchstart="startResize(event, '${windowId}', 'n')"></div>
                    <div class="resize-s" onmousedown="startResize(event, '${windowId}', 's')" ontouchstart="startResize(event, '${windowId}', 's')"></div>
                    <div class="resize-e" onmousedown="startResize(event, '${windowId}', 'e')" ontouchstart="startResize(event, '${windowId}', 'e')"></div>
                    <div class="resize-w" onmousedown="startResize(event, '${windowId}', 'w')" ontouchstart="startResize(event, '${windowId}', 'w')"></div>
                    <div class="resize-ne" onmousedown="startResize(event, '${windowId}', 'ne')" ontouchstart="startResize(event, '${windowId}', 'ne')"></div>
                    <div class="resize-nw" onmousedown="startResize(event, '${windowId}', 'nw')" ontouchstart="startResize(event, '${windowId}', 'nw')"></div>
                    <div class="resize-se" onmousedown="startResize(event, '${windowId}', 'se')" ontouchstart="startResize(event, '${windowId}', 'se')"></div>
                    <div class="resize-sw" onmousedown="startResize(event, '${windowId}', 'sw')" ontouchstart="startResize(event, '${windowId}', 'sw')"></div>
                `;

            els.windowsContainer.appendChild(windowEl);
            state.windows.push({ id: windowId, element: windowEl, app, path });
            focusWindow(windowId);
            showNotification('Launched', `${app.name} is now running`, app.icon, app.color);

            // Initialize custom app if needed
            if (app.isCustom) {
                setTimeout(() => initCustomApp(windowId, app.customIndex), 100);
            }
        }

        function generateAppContent(appId, windowId, path, app) {
            switch(appId) {
                case 'terminal':
                    return `
                        <div class="p-4 font-mono text-sm h-full overflow-auto bg-hypr-bg/80" id="term-${windowId}">
                            <div class="text-green-400 mb-2">user@hypr-os ~ $ neofetch</div>
                            <div class="text-hypr-text mb-4 font-mono text-xs leading-relaxed opacity-80">
                                <span class="text-hypr-accent">  OS:</span> HyprOS Web Edition<br>
                                <span class="text-hypr-accent">  Host:</span> ${navigator.platform}<br>
                                <span class="text-hypr-accent">  Browser:</span> ${navigator.userAgent.split(')')[0].split('(')[1] || 'Unknown'}<br>
                                <span class="text-hypr-accent">  Memory:</span> ${navigator.deviceMemory || '?'}GB<br>
                                <span class="text-hypr-accent">  Cores:</span> ${navigator.hardwareConcurrency || '?'}<br>
                                <span class="text-hypr-accent">  Online:</span> ${navigator.onLine ? 'Yes' : 'No'}<br>
                            </div>
                            <div class="text-green-400 flex items-center gap-2">
                                user@hypr-os ~ $ 
                                <input type="text" class="bg-transparent border-none outline-none text-hypr-text flex-1 font-mono" 
                                       onkeydown="handleTerminal(event, '${windowId}')" 
                                       placeholder="type 'help' for commands" autocomplete="off" id="input-${windowId}">
                            </div>
                        </div>`;
                
                case 'files':
                    const initialPath = path || ['Home'];
                    return `
                        <div class="flex h-full text-sm">
                            <div class="w-48 border-r border-white/10 p-2 space-y-1 overflow-auto bg-hypr-surface/30">
                                <div class="text-xs font-bold text-hypr-muted uppercase mb-2 p-2">Locations</div>
                                <div class="file-item ${initialPath.length === 1 && initialPath[0] === 'Home' ? 'selected' : ''}" onclick="navigateTo('${windowId}', ['Home'])">
                                    <i class="fas fa-home text-hypr-accent"></i> Home
                                </div>
                                <div class="file-item" onclick="navigateTo('${windowId}', ['Home', 'Documents'])">
                                    <i class="fas fa-file-alt text-blue-400"></i> Documents
                                </div>
                                <div class="file-item" onclick="navigateTo('${windowId}', ['Home', 'Pictures'])">
                                    <i class="fas fa-image text-purple-400"></i> Pictures
                                </div>
                                <div class="file-item" onclick="navigateTo('${windowId}', ['Home', 'Music'])">
                                    <i class="fas fa-music text-pink-400"></i> Music
                                </div>
                                <div class="file-item" onclick="navigateTo('${windowId}', ['Home', 'Downloads'])">
                                    <i class="fas fa-download text-green-400"></i> Downloads
                                </div>
                                <div class="mt-4 pt-4 border-t border-white/10">
                                    <div class="file-item" onclick="openApp('trash')">
                                        <i class="fas fa-trash text-gray-400"></i> Trash
                                    </div>
                                </div>
                            </div>
                            <div class="flex-1 flex flex-col">
                                <div class="h-10 border-b border-white/10 flex items-center justify-between px-4 bg-white/5">
                                    <div class="flex items-center gap-2 text-xs" id="breadcrumb-${windowId}">
                                        ${initialPath.join(' / ')}
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="createNewFile('${windowId}')" class="text-xs bg-hypr-accent/20 text-hypr-accent px-3 py-1 rounded hover:bg-hypr-accent/30">
                                            <i class="fas fa-file mr-1"></i> New File
                                        </button>
                                        <button onclick="createNewFolder('${windowId}')" class="text-xs bg-hypr-surface text-hypr-text px-3 py-1 rounded hover:bg-white/10">
                                            <i class="fas fa-folder mr-1"></i> New Folder
                                        </button>
                                    </div>
                                </div>
                                <div class="flex-1 p-4 overflow-auto" id="files-area-${windowId}" oncontextmenu="showFilesContextMenu(event, '${windowId}')">
                                    ${renderFileGrid(initialPath, windowId)}
                                </div>
                            </div>
                        </div>`;
                
                case 'trash':
                    return `
                        <div class="flex flex-col h-full">
                            <div class="h-10 border-b border-white/10 flex items-center justify-between px-4 bg-white/5">
                                <span class="text-sm font-bold">Trash</span>
                                <button onclick="emptyTrash()" class="text-xs bg-hypr-error/20 text-hypr-error px-3 py-1 rounded hover:bg-hypr-error/30">
                                    <i class="fas fa-trash-alt mr-1"></i> Empty Trash
                                </button>
                            </div>
                            <div class="flex-1 p-4 overflow-auto" id="trash-area-${windowId}">
                                ${renderTrash()}
                            </div>
                        </div>`;
                
                case 'browser':
                    return `
                        <div class="flex flex-col h-full">
                            <div class="flex items-center gap-2 p-2 border-b border-white/10 bg-hypr-surface/30">
                                <div class="flex gap-1">
                                    <button onclick="browserBack('${windowId}')" class="w-8 h-8 rounded hover:bg-white/10 flex items-center justify-center"><i class="fas fa-arrow-left"></i></button>
                                    <button onclick="browserForward('${windowId}')" class="w-8 h-8 rounded hover:bg-white/10 flex items-center justify-center"><i class="fas fa-arrow-right"></i></button>
                                    <button onclick="browserReload('${windowId}')" class="w-8 h-8 rounded hover:bg-white/10 flex items-center justify-center"><i class="fas fa-rotate-right"></i></button>
                                </div>
                                <div class="flex-1 bg-hypr-bg rounded-lg px-3 py-2 text-sm flex items-center gap-2 border border-hypr-border focus-within:border-hypr-accent">
                                    <i class="fas fa-lock text-hypr-success text-xs"></i>
                                    <input type="text" id="url-${windowId}" class="bg-transparent border-none outline-none text-hypr-text flex-1" 
                                           value="https://example.com" onkeydown="if(event.key==='Enter')navigateBrowser('${windowId}')">
                                </div>
                                <button onclick="navigateBrowser('${windowId}')" class="w-8 h-8 rounded hover:bg-white/10 flex items-center justify-center">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                            <iframe id="iframe-${windowId}" src="https://example.com" class="flex-1 bg-white" sandbox="allow-same-origin allow-scripts allow-popups allow-forms"></iframe>
                        </div>`;
                
                case 'code':
                    return `
                        <div class="flex h-full text-sm font-mono">
                            <div class="w-48 border-r border-white/10 p-2 space-y-1 overflow-auto bg-hypr-surface/30">
                                <div class="flex items-center gap-2 p-2 rounded bg-hypr-accent/20 text-hypr-accent cursor-pointer">
                                    <i class="fas fa-file-code"></i> untitled.txt
                                </div>
                            </div>
                            <div class="flex-1 flex flex-col">
                                <div class="flex items-center justify-between px-4 py-2 border-b border-white/10 bg-white/5">
                                    <span class="text-xs text-hypr-muted">untitled.txt</span>
                                    <div class="flex gap-2">
                                        <button onclick="saveTextFile('${windowId}')" class="text-xs bg-hypr-accent/20 text-hypr-accent px-3 py-1 rounded hover:bg-hypr-accent/30">
                                            <i class="fas fa-save mr-1"></i> Save
                                        </button>
                                        <button onclick="openTextFile('${windowId}')" class="text-xs bg-hypr-surface px-3 py-1 rounded hover:bg-white/10">
                                            <i class="fas fa-folder-open mr-1"></i> Open
                                        </button>
                                    </div>
                                </div>
                                <textarea id="editor-${windowId}" class="flex-1 bg-hypr-bg/50 p-4 resize-none outline-none text-hypr-text font-mono text-sm" 
                                          placeholder="Start typing..."></textarea>
                                <input type="file" id="file-open-${windowId}" class="hidden" accept=".txt,.md,.js,.py,.html,.css" onchange="handleTextFileOpen(this, '${windowId}')">
                            </div>
                        </div>`;
                
                case 'music':
                    return `
                        <div class="flex h-full">
                            <div class="w-64 border-r border-white/10 p-4 space-y-4 overflow-auto">
                                <div class="border-2 border-dashed border-hypr-border rounded-lg p-4 text-center hover:border-hypr-accent transition-colors cursor-pointer relative">
                                    <input type="file" id="music-upload-${windowId}" accept="audio/*" multiple 
                                           class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleMusicUpload(this, '${windowId}')">
                                    <i class="fas fa-plus text-hypr-accent text-2xl mb-2"></i>
                                    <p class="text-xs text-hypr-muted">Add music files</p>
                                </div>
                                <div class="text-xs font-bold text-hypr-muted uppercase">Library</div>
                                <div class="space-y-1" id="playlist-${windowId}"></div>
                            </div>
                            <div class="flex-1 flex flex-col p-6">
                                <div class="flex-1 flex items-center justify-center">
                                    <div class="text-center">
                                        <div class="w-48 h-48 rounded-2xl bg-gradient-to-br from-hypr-accent to-hypr-accent2 flex items-center justify-center mb-6 shadow-2xl" id="album-art-${windowId}">
                                            <i class="fas fa-music text-6xl text-white"></i>
                                        </div>
                                        <h2 class="text-2xl font-bold mb-1" id="track-title-${windowId}">No track</h2>
                                        <p class="text-hypr-muted" id="track-artist-${windowId}">Add music to play</p>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div class="audio-visualizer justify-center" id="visualizer-${windowId}">
                                        ${Array(20).fill(0).map(() => `<div class="audio-bar" style="height: 4px"></div>`).join('')}
                                    </div>
                                    <div class="flex items-center justify-center gap-6">
                                        <button onclick="prevTrack('${windowId}')" class="text-hypr-muted hover:text-hypr-text"><i class="fas fa-step-backward text-xl"></i></button>
                                        <button onclick="toggleMusic('${windowId}')" id="play-btn-${windowId}" class="w-14 h-14 rounded-full bg-hypr-accent text-hypr-bg flex items-center justify-center hover:scale-110">
                                            <i class="fas fa-play text-xl ml-1"></i>
                                        </button>
                                        <button onclick="nextTrack('${windowId}')" class="text-hypr-muted hover:text-hypr-text"><i class="fas fa-step-forward text-xl"></i></button>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-xs text-hypr-muted w-10 text-right" id="current-time-${windowId}">0:00</span>
                                        <div class="flex-1 h-1 bg-white/10 rounded-full overflow-hidden cursor-pointer" onclick="seekMusic(event, '${windowId}')">
                                            <div id="progress-${windowId}" class="h-full bg-hypr-accent w-0"></div>
                                        </div>
                                        <span class="text-xs text-hypr-muted w-10" id="duration-${windowId}">0:00</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <audio id="audio-${windowId}" crossorigin="anonymous" preload="metadata"></audio>`;
                        
                case 'calculator':
                    return `
                        <div class="p-6 h-full flex flex-col">
                            <div class="flex-1 flex items-end justify-end p-4 text-5xl font-mono text-hypr-text mb-4 bg-hypr-surface/30 rounded-lg break-all" id="calc-display-${windowId}">0</div>
                            <div class="grid grid-cols-4 gap-3">
                                ${['C', '', '%', '', '7', '8', '9', '', '4', '5', '6', '-', '1', '2', '3', '+', '0', '.', '='].map(btn => {
                                    const isOp = ['', '', '-', '+', '='].includes(btn);
                                    const isFn = ['C', '', '%'].includes(btn);
                                    const span = btn === '0' ? 'col-span-2' : '';
                                    const color = isOp ? 'bg-hypr-accent text-hypr-bg' : isFn ? 'bg-hypr-surface text-hypr-text' : 'bg-hypr-surface/50 text-hypr-text';
                                    return `<button onclick="calcInput('${btn}', '${windowId}')" class="${span} ${color} h-14 rounded-lg font-bold hover:brightness-110 transition-all text-lg">${btn}</button>`;
                                }).join('')}
                            </div>
                        </div>`;
                
                case 'paint':
                    return `
                        <div class="flex flex-col h-full">
                            <div class="h-12 border-b border-white/10 flex items-center gap-2 px-4 bg-white/5">
                                <button onclick="clearCanvas('${windowId}')" class="p-2 rounded hover:bg-white/10" title="Clear"><i class="fas fa-trash"></i></button>
                                <div class="w-px h-6 bg-white/10 mx-2"></div>
                                <input type="color" id="color-${windowId}" value="#cba6f7" class="w-8 h-8 rounded cursor-pointer bg-transparent border-none">
                                <input type="range" id="brush-${windowId}" min="1" max="50" value="5" class="w-24">
                                <div class="flex-1"></div>
                                <button onclick="saveCanvas('${windowId}')" class="px-3 py-1 bg-hypr-accent/20 text-hypr-accent rounded hover:bg-hypr-accent/30 text-sm">
                                    <i class="fas fa-download mr-1"></i> Save
                                </button>
                                <button onclick="saveCanvasToFS('${windowId}')" class="px-3 py-1 bg-hypr-success/20 text-hypr-success rounded hover:bg-hypr-success/30 text-sm">
                                    <i class="fas fa-save mr-1"></i> Save to Files
                                </button>
                            </div>
                            <div class="flex-1 relative overflow-hidden bg-white">
                                <canvas id="canvas-${windowId}" class="absolute inset-0 cursor-crosshair touch-none"></canvas>
                            </div>
                        </div>`;
                
                case 'taskmanager':
                    return `
                        <div class="flex flex-col h-full">
                            <div class="h-10 border-b border-white/10 flex items-center justify-between px-4 bg-white/5">
                                <span class="text-sm font-bold">Task Manager</span>
                                <button onclick="refreshTaskManager('${windowId}')" class="text-xs bg-hypr-accent/20 text-hypr-accent px-3 py-1 rounded hover:bg-hypr-accent/30">
                                    <i class="fas fa-refresh mr-1"></i> Refresh
                                </button>
                            </div>
                            <div class="flex-1 overflow-auto p-4" id="task-list-${windowId}">
                                ${renderTaskList()}
                            </div>
                        </div>`;
                
                case 'appcreator':
                    return `
                        <div class="flex flex-col h-full">
                            <div class="h-10 border-b border-white/10 flex items-center justify-between px-4 bg-white/5">
                                <span class="text-sm font-bold">App Creator</span>
                                <div class="flex gap-2">
                                    <button onclick="saveCustomApp()" class="text-xs bg-hypr-success/20 text-hypr-success px-3 py-1 rounded hover:bg-hypr-success/30">
                                        <i class="fas fa-save mr-1"></i> Save App
                                    </button>
                                    <button onclick="testCustomApp()" class="text-xs bg-hypr-accent/20 text-hypr-accent px-3 py-1 rounded hover:bg-hypr-accent/30">
                                        <i class="fas fa-play mr-1"></i> Test
                                    </button>
                                </div>
                            </div>
                            </div>
                            <div class="flex-1 overflow-auto p-4 space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-xs text-hypr-muted block mb-1">App Name</label>
                                        <input type="text" id="ca-name" class="w-full bg-hypr-surface border border-hypr-border rounded-lg px-3 py-2 text-sm focus:border-hypr-accent outline-none" placeholder="My App">
                                    </div>
                                    <div>
                                        <label class="text-xs text-hypr-muted block mb-1">Icon Class (fa-*)</label>
                                        <input type="text" id="ca-icon" class="w-full bg-hypr-surface border border-hypr-border rounded-lg px-3 py-2 text-sm focus:border-hypr-accent outline-none" placeholder="fa-rocket">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs text-hypr-muted block mb-1">Icon Color</label>
                                    <select id="ca-color" class="w-full bg-hypr-surface border border-hypr-border rounded-lg px-3 py-2 text-sm focus:border-hypr-accent outline-none">
                                        <option value="text-red-400">Red</option>
                                        <option value="text-orange-400">Orange</option>
                                        <option value="text-yellow-400">Yellow</option>
                                        <option value="text-green-400">Green</option>
                                        <option value="text-cyan-400">Cyan</option>
                                        <option value="text-blue-400">Blue</option>
                                        <option value="text-purple-400">Purple</option>
                                        <option value="text-pink-400">Pink</option>
                                        <option value="text-hypr-accent" selected>Accent</option>
                                        <option value="text-white">White</option>
                                    </select>
                                </div>
                                <div class="flex-1 flex flex-col">
                                    <label class="text-xs text-hypr-muted block mb-1">HTML Content</label>
                                    <textarea id="ca-html" class="flex-1 bg-hypr-surface border border-hypr-border rounded-lg px-3 py-2 text-sm focus:border-hypr-accent outline-none font-mono text-xs" placeholder="<div>Your HTML here</div>"></textarea>
                                </div>
                                <div class="flex-1 flex flex-col">
                                    <label class="text-xs text-hypr-muted block mb-1">CSS Styles</label>
                                    <textarea id="ca-css" class="flex-1 bg-hypr-surface border border-hypr-border rounded-lg px-3 py-2 text-sm focus:border-hypr-accent outline-none font-mono text-xs" placeholder=".my-class { color: red; }"></textarea>
                                </div>
                                <div class="flex-1 flex flex-col">
                                    <label class="text-xs text-hypr-muted block mb-1">JavaScript</label>
                                    <textarea id="ca-js" class="flex-1 bg-hypr-surface border border-hypr-border rounded-lg px-3 py-2 text-sm focus:border-hypr-accent outline-none font-mono text-xs" placeholder="// Your JS here"></textarea>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-white/10">
                                <div class="text-xs font-bold text-hypr-muted uppercase mb-2">Saved Apps</div>
                                <div class="space-y-2" id="saved-apps-list-${windowId}">
                                    ${renderSavedApps(windowId)}
                                </div>
                            </div>
                        </div>`;
                
                default:
                    if (app && app.isCustom) {
                        return `<div id="custom-app-${windowId}" class="h-full w-full overflow-auto bg-hypr-bg/50"></div>`;
                    }
                    return `<div class="p-8 text-center"><i class="fas fa-cube text-6xl text-hypr-muted mb-4"></i><p>Application "${appId}"</p></div>`;
            }
        }

        // Custom App Functions
        function initCustomApp(windowId, customIndex) {
            // For test apps, find by checking if index is out of bounds of saved apps
            // or if the app data was passed differently
            let app;
            
            // Check if this is a test window (customIndex might be invalid after pop)
            const win = state.windows.find(w => w.id === windowId);
            if (!win) return;
            
            // Try to get app data from the window's stored reference or find in customApps
            if (win.customAppData) {
                app = win.customAppData;
            } else if (customIndex >= 0 && customIndex < customApps.length) {
                app = customApps[customIndex];
                win.customAppData = app; // Store reference for later
            } else {
                // Test app case - data might have been lost, reconstruct from form
                const html = document.getElementById('ca-html')?.value || '';
                const css = document.getElementById('ca-css')?.value || '';
                const js = document.getElementById('ca-js')?.value || '';
                app = { html, css, js };
                win.customAppData = app;
            }
            
            if (!app) return;
            
            const container = document.getElementById(`custom-app-${windowId}`);
            if (!container) return;
            
            // Clear existing content
            container.innerHTML = '';
            
            // Create shadow DOM to isolate styles
            let shadow = container.shadowRoot;
            if (!shadow) {
                shadow = container.attachShadow({ mode: 'open' });
            } else {
                shadow.innerHTML = ''; // Clear existing
            }
            
            // Add CSS
            if (app.css) {
                const style = document.createElement('style');
                style.textContent = app.css;
                shadow.appendChild(style);
            }
            
            // Add HTML
            if (app.html) {
                const wrapper = document.createElement('div');
                wrapper.innerHTML = app.html;
                shadow.appendChild(wrapper);
            }
            
            // Add JS
            if (app.js) {
                const script = document.createElement('script');
                script.textContent = `
                    (function(windowRef) {
                        try {
                            ${app.js}
                        } catch(e) {
                            console.error('Custom app error:', e);
                        }
                    })(window);
                `;
                shadow.appendChild(script);
            }
        }

        function renderSavedApps(windowId) {
            if (customApps.length === 0) {
                return '<div class="text-xs text-hypr-muted">No saved apps</div>';
            }
            
            return customApps.map((app, idx) => `
                <div class="flex items-center justify-between p-2 rounded-lg bg-hypr-surface/30">
                    <div class="flex items-center gap-2">
                        <i class="fas ${app.icon} ${app.color}"></i>
                        <span class="text-sm">${app.name}</span>
                    </div>
                    <div class="flex gap-1">
                        <button onclick="openApp('custom_${idx}')" class="text-xs bg-hypr-accent/20 text-hypr-accent px-2 py-1 rounded hover:bg-hypr-accent/30">
                            <i class="fas fa-play"></i>
                        </button>
                        <button onclick="addAppToTaskbar(${idx}); refreshAppCreator('${windowId}')" class="text-xs bg-hypr-success/20 text-hypr-success px-2 py-1 rounded hover:bg-hypr-success/30" title="Add to Desktop">
                            <i class="fas fa-desktop"></i>
                        </button>
                        <button onclick="deleteCustomApp(${idx}); refreshAppCreator('${windowId}')" class="text-xs bg-hypr-error/20 text-hypr-error px-2 py-1 rounded hover:bg-hypr-error/30">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function refreshAppCreator(windowId) {
            const container = document.getElementById(`saved-apps-list-${windowId}`);
            if (container) {
                container.innerHTML = renderSavedApps(windowId);
            }
        }
        
        function deleteCustomApp(index) {
            if (confirm('Delete this app?')) {
                customApps.splice(index, 1);
                updateAppsList();
                renderApps();
                saveState();
                showNotification('App Creator', 'App deleted', 'fa-trash');
            }
        }

        function saveCustomApp() {
            const name = document.getElementById('ca-name').value.trim();
            const icon = document.getElementById('ca-icon').value.trim() || 'fa-rocket';
            const color = document.getElementById('ca-color').value;
            const html = document.getElementById('ca-html').value;
            const css = document.getElementById('ca-css').value;
            const js = document.getElementById('ca-js').value;
            
            if (!name) {
                showNotification('Error', 'App name is required', 'fa-exclamation');
                return;
            }
            
            customApps.push({ name, icon, color, html, css, js });
            updateAppsList();
            renderApps();
            saveState();
            showNotification('App Creator', `App "${name}" saved!`, 'fa-check');
        }

        function testCustomApp() {
            const html = document.getElementById('ca-html').value;
            const css = document.getElementById('ca-css').value;
            const js = document.getElementById('ca-js').value;
            
            // Create a temporary test app object
            const testApp = {
                name: 'Test App',
                icon: 'fa-flask',
                color: 'text-yellow-400',
                html, 
                css, 
                js
            };
            
            // Add to customApps temporarily
            const tempIdx = customApps.length;
            customApps.push(testApp);
            
            // Update apps list and open
            updateAppsList();
            openApp(`custom_${tempIdx}`);
            
            // Remove from list after opening (window will keep reference)
            // Don't remove immediately - wait a bit
            setTimeout(() => {
                customApps.pop();
                updateAppsList();
            }, 100);
        }

        // Task Manager Functions
        function renderTaskList() {
            if (state.windows.length === 0) {
                return '<div class="text-hypr-muted text-center mt-8">No running tasks</div>';
            }
            
            return state.windows.map(w => `
                <div class="flex items-center justify-between p-3 rounded-lg bg-hypr-surface/30 hover:bg-hypr-surface/50 mb-2">
                    <div class="flex items-center gap-3">
                        <i class="fas ${w.app.icon} ${w.app.color}"></i>
                        <div>
                            <div class="text-sm font-bold">${w.app.name}</div>
                            <div class="text-xs text-hypr-muted">ID: ${w.id}</div>
                        </div>
                    </div>
                    <button onclick="closeWindow('${w.id}')" class="px-3 py-1 bg-hypr-error/20 text-hypr-error rounded hover:bg-hypr-error/30 text-xs">
                        <i class="fas fa-times mr-1"></i> End Task
                    </button>
                </div>
            `).join('');
        }

        function refreshTaskManager(windowId) {
            document.getElementById(`task-list-${windowId}`).innerHTML = renderTaskList();
        }

        // File Manager Functions
        function renderFileGrid(path, windowId) {
            const folder = getFolder(path);
            if (!folder || !folder.children) return '<div class="text-hypr-muted">Empty folder</div>';
            
            const entries = Object.entries(folder.children);
            if (entries.length === 0) return '<div class="text-hypr-muted text-center mt-8">Empty folder</div>';
            
            return entries.map(([name, item]) => `
                <div class="file-item p-3 rounded-lg hover:bg-white/5 cursor-pointer group" 
                     onclick="handleFileClick('${windowId}', '${name}', '${item.type}')"
                     oncontextmenu="showFileContextMenu(event, '${windowId}', '${name}')">
                    <i class="fas ${item.type === 'folder' ? 'fa-folder text-yellow-400' : getFileIcon(name)} text-2xl w-10"></i>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm truncate">${name}</div>
                        <div class="text-xs text-hypr-muted">${item.type === 'folder' ? 'Folder' : formatFileSize(item.content)}  ${new Date(item.lastModified).toLocaleDateString()}</div>
                    </div>
                    ${item.type === 'file' ? `<button onclick="event.stopPropagation(); openFileInEditor('${windowId}', '${name}')" class="opacity-0 group-hover:opacity-100 text-hypr-muted hover:text-hypr-accent"><i class="fas fa-edit"></i></button>` : ''}
                </div>
            `).join('');
        }

        function getFileIcon(filename) {
            if (filename.endsWith('.txt') || filename.endsWith('.md')) return 'fa-file-alt text-gray-400';
            if (filename.endsWith('.js') || filename.endsWith('.py') || filename.endsWith('.html')) return 'fa-file-code text-blue-400';
            if (filename.endsWith('.json')) return 'fa-file-code text-yellow-400';
            if (filename.endsWith('.png') || filename.endsWith('.jpg') || filename.endsWith('.jpeg')) return 'fa-image text-purple-400';
            if (filename.endsWith('.mp3') || filename.endsWith('.wav') || filename.endsWith('.ogg') || filename.endsWith('.m4a') || filename.endsWith('.flac') || filename.endsWith('.aac')) return 'fa-music text-pink-400';
            return 'fa-file text-gray-400';
        }

        function formatFileSize(content) {
            if (typeof content !== 'string') return 'Unknown';
            const bytes = new Blob([content]).size;
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function handleFileClick(windowId, name, type) {
            const win = state.windows.find(w => w.id === windowId);
            if (type === 'folder') {
                win.path.push(name);
                refreshFileWindow(windowId);
            } else {
                // Check if it's an audio file
                const audioExtensions = ['.mp3', '.wav', '.ogg', '.m4a', '.flac', '.aac', '.webm'];
                const isAudio = audioExtensions.some(ext => name.toLowerCase().endsWith(ext));
                
                if (isAudio) {
                    openAudioInMusicApp(windowId, name);
                } else {
                    openFileInEditor(windowId, name);
                }
            }
        }

        function openAudioInMusicApp(fileWindowId, filename) {
            const win = state.windows.find(w => w.id === fileWindowId);
            const folder = getFolder(win.path);
            const file = folder.children[filename];
            
            if (file && file.type === 'file') {
                // Open music app
                openApp('music');
                
                setTimeout(() => {
                    const musicWin = state.windows.find(w => w.app.id === 'music');
                    if (musicWin) {
                        // Add to music files if not already there
                        const existingIndex = state.musicFiles.findIndex(m => m.name === filename.replace(/\.[^/.]+$/, ""));
                        let trackIndex;
                        
                        if (existingIndex === -1) {
                            // Add new track
                            state.musicFiles.push({
                                name: filename.replace(/\.[^/.]+$/, ""),
                                artist: "Unknown",
                                url: file.content,
                                file: { name: filename }
                            });
                            trackIndex = state.musicFiles.length - 1;
                        } else {
                            trackIndex = existingIndex;
                        }
                        
                        // Update playlist and load track
                        updatePlaylist(musicWin.id);
                        loadTrack(trackIndex, musicWin.id);
                        
                        // Auto-play after user interaction (browser requirement)
                        const audio = document.getElementById(`audio-${musicWin.id}`);
                        if (audio) {
                            audio.play().then(() => {
                                updatePlayButton(musicWin.id, true);
                                startVisualizer(musicWin.id);
                            }).catch(e => {
                                console.log('Auto-play prevented, user must click play');
                                // Keep it loaded but not playing - user can click play
                            });
                        }
                    }
                }, 200);
            }
        }

        function loadTrack(index, windowId) {
            if (!audioPlayers[windowId]) {
                audioPlayers[windowId] = { 
                    audio: document.getElementById(`audio-${windowId}`) || new Audio(), 
                    currentTrack: 0,
                    isPlaying: false
                };
            }
            
            const player = audioPlayers[windowId];
            
            // Stop current playback
            player.audio.pause();
            player.audio.currentTime = 0;
            
            player.currentTrack = index;
            const track = state.musicFiles[index];
            
            if (!track) return;
            
            // Set source
            player.audio.src = track.url;
            player.audio.load();
            
            // Update UI
            document.getElementById(`track-title-${windowId}`).textContent = track.name;
            document.getElementById(`track-artist-${windowId}`).textContent = track.artist || "Unknown";
            
            // Reset progress
            document.getElementById(`progress-${windowId}`).style.width = '0%';
            document.getElementById(`current-time-${windowId}`).textContent = '0:00';
            document.getElementById(`duration-${windowId}`).textContent = '0:00';
            
            // Event listeners
            player.audio.onloadedmetadata = () => {
                document.getElementById(`duration-${windowId}`).textContent = formatTime(player.audio.duration);
            };
            
            player.audio.ontimeupdate = () => {
                if (player.audio.duration) {
                    const progress = (player.audio.currentTime / player.audio.duration) * 100;
                    document.getElementById(`progress-${windowId}`).style.width = progress + '%';
                    document.getElementById(`current-time-${windowId}`).textContent = formatTime(player.audio.currentTime);
                }
            };
            
            player.audio.onended = () => {
                updatePlayButton(windowId, false);
                stopVisualizer(windowId);
                nextTrack(windowId);
            };
            
            player.audio.onerror = (e) => {
                console.error('Audio error:', e);
                showNotification('Music', 'Error playing track', 'fa-exclamation');
                updatePlayButton(windowId, false);
                stopVisualizer(windowId);
            };
            
            // Update playlist highlighting
            updatePlaylist(windowId);
            
            // Try to play (may be blocked by browser without user interaction)
            player.audio.play().then(() => {
                player.isPlaying = true;
                updatePlayButton(windowId, true);
                startVisualizer(windowId);
            }).catch(e => {
                player.isPlaying = false;
                updatePlayButton(windowId, false);
            });
        }

        function navigateTo(windowId, path) {
            const win = state.windows.find(w => w.id === windowId);
            win.path = path;
            refreshFileWindow(windowId);
        }

        function refreshFileWindow(windowId) {
            const win = state.windows.find(w => w.id === windowId);
            document.getElementById(`breadcrumb-${windowId}`).textContent = win.path.join(' / ');
            document.getElementById(`files-area-${windowId}`).innerHTML = renderFileGrid(win.path, windowId);
        }

        function createNewFile(windowId) {
            const name = prompt('File name:');
            if (name) {
                const win = state.windows.find(w => w.id === windowId);
                if (createFile(win.path, name, '')) {
                    refreshFileWindow(windowId);
                    showNotification('Files', `Created ${name}`, 'fa-file');
                }
            }
        }

        function createNewFolder(windowId) {
            const name = prompt('Folder name:');
            if (name) {
                const win = state.windows.find(w => w.id === windowId);
                if (createFolder(win.path, name)) {
                    refreshFileWindow(windowId);
                    showNotification('Files', `Created ${name}`, 'fa-folder');
                }
            }
        }

        function openFileInEditor(windowId, filename) {
            const win = state.windows.find(w => w.id === windowId);
            const folder = getFolder(win.path);
            const file = folder.children[filename];
            if (file && file.type === 'file') {
                openApp('code');
                setTimeout(() => {
                    const editorWin = state.windows[state.windows.length - 1];
                    if (editorWin && editorWin.app.id === 'code') {
                        document.getElementById(`editor-${editorWin.id}`).value = file.content;
                        document.getElementById(`title-${editorWin.id}`).textContent = filename;
                        editorWin.editingFile = { path: win.path, name: filename };
                    }
                }, 100);
            }
        }

        function renderTrash() {
            const entries = Object.entries(fileSystem.trash);
            if (entries.length === 0) return '<div class="text-hypr-muted text-center mt-8">Trash is empty</div>';
            
            return entries.map(([name, item]) => `
                <div class="file-item p-3 rounded-lg hover:bg-white/5 cursor-pointer">
                    <i class="fas ${item.type === 'folder' ? 'fa-folder text-yellow-400' : 'fa-file text-gray-400'} text-2xl w-10"></i>
                    <div class="flex-1 min-w-0">
                        <div class="text-sm truncate">${name.split('_')[0]}</div>
                        <div class="text-xs text-hypr-muted">${item.type}  Deleted</div>
                    </div>
                    <button onclick="restoreFromTrash('${name}')" class="text-hypr-success hover:text-hypr-accent mr-2" title="Restore">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button onclick="permanentDelete('${name}')" class="text-hypr-error hover:text-red-400" title="Delete Forever">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `).join('');
        }

        function permanentDelete(name) {
            delete fileSystem.trash[name];
            saveState();
            state.windows.forEach(w => {
                if (w.app.id === 'trash') {
                    document.getElementById(`trash-area-${w.id}`).innerHTML = renderTrash();
                }
            });
            showNotification('Trash', 'File permanently deleted', 'fa-trash');
        }

        // Context Menus
        function showContextMenu(x, y, items) {
            const menu = els.contextMenu;
            menu.innerHTML = items.map(item => `
                <div class="context-menu-item" onclick="${item.action}(); hideContextMenu()">
                    <i class="fas ${item.icon} w-4"></i>
                    ${item.label}
                </div>
            `).join('');
            menu.style.left = Math.min(x, window.innerWidth - 180) + 'px';
            menu.style.top = Math.min(y, window.innerHeight - 200) + 'px';
            menu.classList.remove('hidden');
        }

        function hideContextMenu() {
            els.contextMenu.classList.add('hidden');
        }

        function showFilesContextMenu(e, windowId) {
            e.preventDefault();
            showContextMenu(e.clientX, e.clientY, [
                { label: 'New File', icon: 'fa-file', action: () => createNewFile(windowId) },
                { label: 'New Folder', icon: 'fa-folder', action: () => createNewFolder(windowId) },
                { label: 'Refresh', icon: 'fa-rotate-right', action: () => refreshFileWindow(windowId) }
            ]);
        }

        function showFileContextMenu(e, windowId, filename) {
            e.preventDefault();
            e.stopPropagation();
            showContextMenu(e.clientX, e.clientY, [
                { label: 'Open', icon: 'fa-folder-open', action: () => handleFileClick(windowId, filename, 'file') },
                { label: 'Rename', icon: 'fa-edit', action: () => renameFile(windowId, filename) },
                { label: 'Delete', icon: 'fa-trash', action: () => deleteFileFromWindow(windowId, filename) }
            ]);
        }

        function renameFile(windowId, oldName) {
            const newName = prompt('New name:', oldName);
            if (newName && newName !== oldName) {
                const win = state.windows.find(w => w.id === windowId);
                const folder = getFolder(win.path);
                folder.children[newName] = folder.children[oldName];
                folder.children[newName].lastModified = Date.now();
                delete folder.children[oldName];
                saveState();
                refreshFileWindow(windowId);
            }
        }

        function deleteFileFromWindow(windowId, filename) {
            const win = state.windows.find(w => w.id === windowId);
            if (moveToTrash(win.path, filename)) {
                refreshFileWindow(windowId);
                showNotification('Files', 'Moved to trash', 'fa-trash');
            }
        }

        // Text Editor Functions
        function saveTextFile(windowId) {
            const win = state.windows.find(w => w.id === windowId);
            const content = document.getElementById(`editor-${windowId}`).value;
            
            if (win.editingFile) {
                const folder = getFolder(win.editingFile.path);
                folder.children[win.editingFile.name].content = content;
                folder.children[win.editingFile.name].lastModified = Date.now();
                saveState();
                showNotification('Editor', 'File saved', 'fa-save');
            } else {
                const name = prompt('Save as:', 'untitled.txt');
                if (name) {
                    createFile(['Home', 'Documents'], name, content);
                    showNotification('Editor', `Saved as ${name}`, 'fa-save');
                }
            }
        }

        function openTextFile(windowId) {
            document.getElementById(`file-open-${windowId}`).click();
        }

        function handleTextFileOpen(input, windowId) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById(`editor-${windowId}`).value = e.target.result;
                    document.getElementById(`title-${windowId}`).textContent = file.name;
                };
                reader.readAsText(file);
            }
        }

        // Terminal Functions
        const commandHistory = {};
        
        function handleTerminal(e, windowId) {
            if (e.key === 'Enter') {
                const input = e.target;
                const cmd = input.value.trim();
                const term = document.getElementById('term-' + windowId);
                
                if (!commandHistory[windowId]) commandHistory[windowId] = [];
                commandHistory[windowId].push(cmd);
                
                const line = document.createElement('div');
                line.className = 'text-green-400 mb-1';
                line.innerHTML = `user@hypr-os ~ $ <span class="text-hypr-text">${cmd}</span>`;
                term.insertBefore(line, term.lastElementChild);
                
                let output = processCommand(cmd, windowId);
                
                if (output) {
                    const outLine = document.createElement('div');
                    outLine.className = 'text-hypr-text mb-2 whitespace-pre-wrap';
                    outLine.textContent = output;
                    term.insertBefore(outLine, term.lastElementChild);
                }
                
                input.value = '';
                term.scrollTop = term.scrollHeight;
            }
        }

        function processCommand(cmd, windowId) {
            const parts = cmd.split(' ');
            const command = parts[0];
            const args = parts.slice(1);
            
            switch(command) {
                case 'help':
                    return `Available commands:
  help, clear, ls, pwd, cd, mkdir, touch, rm, cat, echo, neofetch
  open <app>, edit <file>, date, whoami, uname, export, import`;
                
                case 'clear':
                    const term = document.getElementById('term-' + windowId);
                    term.innerHTML = `
                        <div class="text-green-400 flex items-center gap-2">
                            user@hypr-os ~ $ 
                            <input type="text" class="bg-transparent border-none outline-none text-hypr-text flex-1 font-mono" 
                                   onkeydown="handleTerminal(event, '${windowId}')" autocomplete="off">
                        </div>`;
                    term.querySelector('input').focus();
                    return null;
                
                case 'ls':
                    const win = state.windows.find(w => w.id === windowId);
                    const folder = getFolder(win?.path || ['Home']);
                    if (folder && folder.children) {
                        return Object.entries(folder.children).map(([name, item]) => {
                            const prefix = item.type === 'folder' ? 'd' : '-';
                            const size = item.type === 'file' ? new Blob([item.content]).size : '-';
                            const date = new Date(item.lastModified).toLocaleDateString();
                            return `${prefix}rwxrwxrwx user user ${size.toString().padStart(8)} ${date} ${name}`;
                        }).join('\n');
                    }
                    return '';
                
                case 'pwd':
                    const w = state.windows.find(w => w.id === windowId);
                    return '/' + (w?.path || ['Home']).join('/');
                
                case 'cd':
                    return 'Use the file manager for navigation';
                
                case 'mkdir':
                    if (args[0]) {
                        const win = state.windows.find(w => w.id === windowId);
                        createFolder(win?.path || ['Home'], args[0]);
                        return `Created directory: ${args[0]}`;
                    }
                    return 'Usage: mkdir <name>';
                
                case 'touch':
                    if (args[0]) {
                        const win = state.windows.find(w => w.id === windowId);
                        createFile(win?.path || ['Home'], args[0], '');
                        return `Created file: ${args[0]}`;
                    }
                    return 'Usage: touch <name>';
                
                case 'rm':
                    if (args[0]) {
                        const win = state.windows.find(w => w.id === windowId);
                        moveToTrash(win?.path || ['Home'], args[0]);
                        return `Moved to trash: ${args[0]}`;
                    }
                    return 'Usage: rm <name>';
                
                case 'cat':
                    if (args[0]) {
                        const win = state.windows.find(w => w.id === windowId);
                        const f = getFolder(win?.path || ['Home']);
                        if (f.children[args[0]] && f.children[args[0]].type === 'file') {
                            return f.children[args[0]].content;
                        }
                        return `File not found: ${args[0]}`;
                    }
                    return 'Usage: cat <filename>';
                
                case 'echo':
                    return args.join(' ');
                
                case 'neofetch':
                    return `OS: HyprOS Web Edition
Host: ${navigator.platform}
Kernel: Browser Engine
Uptime: ${Math.floor(performance.now() / 1000 / 60)} mins
Packages: ${Object.keys(fileSystem.root.children).length}
Shell: zsh
Resolution: ${window.innerWidth}x${window.innerHeight}
DE: Hyprland
WM: Tiling
Theme: Catppuccin
Icons: FontAwesome
Terminal: kitty
CPU: ${navigator.hardwareConcurrency || '?'} cores
Memory: ${navigator.deviceMemory || '?'} GB`;
                
                case 'open':
                    if (args[0]) {
                        openApp(args[0]);
                        return `Opening ${args[0]}...`;
                    }
                    return 'Usage: open <app>';
                
                case 'date':
                    return new Date().toString();
                
                case 'whoami':
                    return 'user';
                
                case 'uname':
                    return 'HyprOS Web';
                
                case 'export':
                    exportFileSystem();
                    return 'Exporting file system...';
                
                case 'import':
                    importFileSystem();
                    return 'Select file to import...';
                
                case '':
                    return '';
                
                default:
                    return `Command not found: ${command}. Type 'help' for available commands.`;
            }
        }

        // Browser Functions
        function navigateBrowser(windowId) {
            const url = document.getElementById(`url-${windowId}`).value;
            const iframe = document.getElementById(`iframe-${windowId}`);
            let finalUrl = url;
            if (!url.startsWith('http')) finalUrl = 'https://' + url;
            iframe.src = finalUrl;
        }

        function browserBack(windowId) {
            try {
                document.getElementById(`iframe-${windowId}`).contentWindow.history.back();
            } catch(e) {}
        }

        function browserForward(windowId) {
            try {
                document.getElementById(`iframe-${windowId}`).contentWindow.history.forward();
            } catch(e) {}
        }

        function browserReload(windowId) {
            const iframe = document.getElementById(`iframe-${windowId}`);
            iframe.src = iframe.src;
        }

        // Music Functions
        let audioPlayers = {};

        function handleMusicUpload(input, windowId) {
            const files = Array.from(input.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64data = e.target.result;
                    const filename = file.name;
                    
                    // Save to file system
                    createFile(['Home', 'Music'], filename, base64data);
                    
                    // Add to music files
                    state.musicFiles.push({
                        name: file.name.replace(/\.[^/.]+$/, ""),
                        artist: "Unknown",
                        url: base64data,
                        file: file
                    });
                    
                    updatePlaylist(windowId);
                };
                reader.readAsDataURL(file);
            });
            showNotification('Music', `Added ${files.length} tracks`, 'fa-music');
        }

        function updatePlaylist(windowId) {
            const playlist = document.getElementById(`playlist-${windowId}`);
            if (state.musicFiles.length === 0) {
                playlist.innerHTML = '<div class="text-xs text-hypr-muted p-2">No tracks</div>';
                return;
            }
            playlist.innerHTML = state.musicFiles.map((track, i) => `
                <div class="flex items-center gap-2 p-2 rounded-lg hover:bg-white/5 cursor-pointer ${audioPlayers[windowId]?.currentTrack === i ? 'bg-hypr-accent/20 text-hypr-accent' : 'text-hypr-muted'}" 
                     onclick="loadTrack(${i}, '${windowId}')">
                    <i class="fas fa-music text-xs"></i>
                    <div class="flex-1 min-w-0">
                        <div class="text-xs truncate">${track.name}</div>
                    </div>
                </div>
            `).join('');
        }

        function loadTrack(index, windowId) {
            if (!audioPlayers[windowId]) audioPlayers[windowId] = { audio: new Audio(), currentTrack: 0 };
            const player = audioPlayers[windowId];
            
            player.currentTrack = index;
            player.audio.src = state.musicFiles[index].url;
            
            document.getElementById(`track-title-${windowId}`).textContent = state.musicFiles[index].name;
            document.getElementById(`track-artist-${windowId}`).textContent = state.musicFiles[index].artist;
            
            player.audio.onloadedmetadata = () => {
                document.getElementById(`duration-${windowId}`).textContent = formatTime(player.audio.duration);
            };
            
            player.audio.ontimeupdate = () => {
                const progress = (player.audio.currentTime / player.audio.duration) * 100;
                document.getElementById(`progress-${windowId}`).style.width = progress + '%';
                document.getElementById(`current-time-${windowId}`).textContent = formatTime(player.audio.currentTime);
            };
            
            player.audio.onended = () => nextTrack(windowId);
            
            updatePlaylist(windowId);
            updatePlayButton(windowId, false);
        }

        function toggleMusic(windowId) {
            const player = audioPlayers[windowId];
            const audioEl = document.getElementById(`audio-${windowId}`);
            
            if (!player && !audioEl) {
                showNotification('Music', 'No track loaded', 'fa-exclamation');
                return;
            }
            
            // Initialize player if needed
            if (!player) {
                audioPlayers[windowId] = {
                    audio: audioEl,
                    currentTrack: 0,
                    isPlaying: false
                };
            }
            
            const audio = player ? player.audio : audioEl;
            
            if (audio.paused) {
                audio.play().then(() => {
                    if (player) player.isPlaying = true;
                    updatePlayButton(windowId, true);
                    startVisualizer(windowId);
                }).catch(err => {
                    console.error('Play error:', err);
                    showNotification('Music', 'Click play to start', 'fa-info');
                });
            } else {
                audio.pause();
                if (player) player.isPlaying = false;
                updatePlayButton(windowId, false);
                stopVisualizer(windowId);
            }
        }

        function updatePlayButton(windowId, isPlaying) {
            const btn = document.getElementById(`play-btn-${windowId}`);
            btn.innerHTML = isPlaying ? '<i class="fas fa-pause text-xl"></i>' : '<i class="fas fa-play text-xl ml-1"></i>';
        }

        function prevTrack(windowId) {
            const player = audioPlayers[windowId];
            if (!player) return;
            let newIndex = player.currentTrack - 1;
            if (newIndex < 0) newIndex = state.musicFiles.length - 1;
            loadTrack(newIndex, windowId);
        }

        function nextTrack(windowId) {
            const player = audioPlayers[windowId];
            if (!player) return;
            let newIndex = player.currentTrack + 1;
            if (newIndex >= state.musicFiles.length) newIndex = 0;
            loadTrack(newIndex, windowId);
        }

        function seekMusic(e, windowId) {
            const player = audioPlayers[windowId];
            if (!player || !player.audio.duration) return;
            const rect = e.currentTarget.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            player.audio.currentTime = percent * player.audio.duration;
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        let visualizerIntervals = {};

        function startVisualizer(windowId) {
            const bars = document.querySelectorAll(`#visualizer-${windowId} .audio-bar`);
            visualizerIntervals[windowId] = setInterval(() => {
                bars.forEach(bar => {
                    const height = Math.random() * 30 + 4;
                    bar.style.height = height + 'px';
                });
            }, 100);
        }

        function stopVisualizer(windowId) {
            if (visualizerIntervals[windowId]) {
                clearInterval(visualizerIntervals[windowId]);
                const bars = document.querySelectorAll(`#visualizer-${windowId} .audio-bar`);
                bars.forEach(bar => bar.style.height = '4px');
            }
        }

        // Calculator
        const calcStates = {};
        function calcInput(val, windowId) {
            if (!calcStates[windowId]) calcStates[windowId] = '';
            
            const display = document.getElementById(`calc-display-${windowId}`);
            if (val === 'C') {
                calcStates[windowId] = '';
                display.textContent = '0';
            } else if (val === '=') {
                try {
                    const expr = calcStates[windowId].replace('', '*').replace('', '/');
                    const result = Function('"use strict"; return (' + expr + ')')();
                    display.textContent = result;
                    calcStates[windowId] = String(result);
                } catch {
                    display.textContent = 'Error';
                    calcStates[windowId] = '';
                }
            } else if (val === '') {
                calcStates[windowId] = calcStates[windowId].startsWith('-') ? calcStates[windowId].slice(1) : '-' + calcStates[windowId];
                display.textContent = calcStates[windowId] || '0';
            } else {
                calcStates[windowId] += val;
                display.textContent = calcStates[windowId];
            }
        }

        // Paint
        const canvasStates = {};

        function initPaint(windowId) {
            const canvas = document.getElementById(`canvas-${windowId}`);
            const ctx = canvas.getContext('2d');
            
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            canvasStates[windowId] = { canvas, ctx, drawing: false };
            
            canvas.addEventListener('mousedown', (e) => startPaint(e, windowId));
            canvas.addEventListener('mousemove', (e) => paint(e, windowId));
            canvas.addEventListener('mouseup', () => stopPaint(windowId));
            canvas.addEventListener('mouseout', () => stopPaint(windowId));
            
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }, { passive: false });
            
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }, { passive: false });
            
            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup', {});
                canvas.dispatchEvent(mouseEvent);
            });
        }

        function startPaint(e, windowId) {
            const state = canvasStates[windowId];
            state.drawing = true;
            const rect = state.canvas.getBoundingClientRect();
            state.ctx.beginPath();
            state.ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function paint(e, windowId) {
            const state = canvasStates[windowId];
            if (!state.drawing) return;
            
            const rect = state.canvas.getBoundingClientRect();
            const color = document.getElementById(`color-${windowId}`).value;
            const size = document.getElementById(`brush-${windowId}`).value;
            
            state.ctx.lineWidth = size;
            state.ctx.lineCap = 'round';
            state.ctx.strokeStyle = color;
            
            state.ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            state.ctx.stroke();
        }

        function stopPaint(windowId) {
            if (canvasStates[windowId]) canvasStates[windowId].drawing = false;
        }

        function clearCanvas(windowId) {
            const state = canvasStates[windowId];
            if (state) {
                state.ctx.fillStyle = 'white';
                state.ctx.fillRect(0, 0, state.canvas.width, state.canvas.height);
            }
        }

        function saveCanvas(windowId) {
            const state = canvasStates[windowId];
            if (state) {
                const link = document.createElement('a');
                link.download = 'drawing.png';
                link.href = state.canvas.toDataURL();
                link.click();
                showNotification('Paint', 'Image saved', 'fa-image');
            }
        }

        function saveCanvasToFS(windowId) {
            const state = canvasStates[windowId];
            if (state) {
                const dataUrl = state.canvas.toDataURL();
                const filename = 'drawing_' + Date.now() + '.png';
                createFile(['Home', 'Pictures'], filename, dataUrl);
                showNotification('Paint', `Saved to Pictures/${filename}`, 'fa-save');
            }
        }

        // Window Management with Touch Support
        function closeWindow(id) {
            const win = state.windows.find(w => w.id === id);
            if (win) {
                if (audioPlayers[id]) {
                    audioPlayers[id].audio.pause();
                    delete audioPlayers[id];
                }
                stopVisualizer(id);
                
                win.element.style.transform = 'scale(0.9)';
                win.element.style.opacity = '0';
                setTimeout(() => {
                    win.element.remove();
                    state.windows = state.windows.filter(w => w.id !== id);
                    if (state.windows.length === 0) {
                        els.activeWindowIndicator.classList.add('opacity-0');
                    }
                    // Refresh task manager if open
                    state.windows.forEach(w => {
                        if (w.app.id === 'taskmanager') {
                            refreshTaskManager(w.id);
                        }
                    });
                }, 200);
            }
        }

        function minimizeWindow(id) {
            const win = state.windows.find(w => w.id === id);
            if (win) win.element.style.display = 'none';
        }

        function maximizeWindow(id) {
            const win = state.windows.find(w => w.id === id);
            if (win) {
                const isMaxed = win.element.style.width === '100%';
                if (isMaxed) {
                    win.element.style.width = '800px';
                    win.element.style.height = '600px';
                    win.element.style.left = '50px';
                    win.element.style.top = '50px';
                    win.element.style.borderRadius = '0.75rem';
                } else {
                    win.element.style.width = '100%';
                    win.element.style.height = '100%';
                    win.element.style.left = '0';
                    win.element.style.top = '0';
                    win.element.style.borderRadius = '0';
                }
            }
        }

        function focusWindow(id) {
            state.windows.forEach(w => {
                w.element.style.zIndex = w.id === id ? '100' : '10';
                if (w.id === id) {
                    w.element.classList.add('active-glow');
                    els.windowTitleText.textContent = w.app.name;
                    els.activeWindowIndicator.classList.remove('opacity-0');
                } else {
                    w.element.classList.remove('active-glow');
                }
            });
        }

        let dragState = { windowId: null, offsetX: 0, offsetY: 0, isTouch: false };

        function startDrag(e, windowId) {
            if (e.target.tagName === 'BUTTON') return;
            e.preventDefault();
            
            const isTouch = e.type === 'touchstart';
            const clientX = isTouch ? e.touches[0].clientX : e.clientX;
            const clientY = isTouch ? e.touches[0].clientY : e.clientY;
            
            const win = state.windows.find(w => w.id === windowId);
            const rect = win.element.getBoundingClientRect();
            
            dragState = {
                windowId,
                offsetX: clientX - rect.left,
                offsetY: clientY - rect.top,
                isTouch
            };
            
            win.element.classList.add('dragging');
            focusWindow(windowId);
        }

        function handleDragMove(e) {
            if (!dragState.windowId) return;
            
            const isTouch = e.type === 'touchmove';
            if (isTouch) e.preventDefault();
            
            const clientX = isTouch ? e.touches[0].clientX : e.clientX;
            const clientY = isTouch ? e.touches[0].clientY : e.clientY;
            
            const win = state.windows.find(w => w.id === dragState.windowId);
            win.element.style.left = (clientX - dragState.offsetX) + 'px';
            win.element.style.top = (clientY - dragState.offsetY) + 'px';
        }

        function handleDragEnd(e) {
            if (dragState.windowId) {
                const win = state.windows.find(w => w.id === dragState.windowId);
                if (win) win.element.classList.remove('dragging');
                dragState.windowId = null;
            }
        }

        let resizeState = { windowId: null, direction: null, startX: 0, startY: 0, startWidth: 0, startHeight: 0, startLeft: 0, startTop: 0 };
        
        function startResize(e, windowId, direction) {
            e.preventDefault();
            e.stopPropagation();
            
            const win = state.windows.find(w => w.id === windowId);
            const rect = win.element.getBoundingClientRect();
            
            const isTouch = e.type === 'touchstart';
            const clientX = isTouch ? e.touches[0].clientX : e.clientX;
            const clientY = isTouch ? e.touches[0].clientY : e.clientY;
            
            resizeState = {
                windowId,
                direction,
                startX: clientX,
                startY: clientY,
                startWidth: rect.width,
                startHeight: rect.height,
                startLeft: rect.left,
                startTop: rect.top,
                isTouch
            };
            
            document.body.style.cursor = getComputedStyle(e.target).cursor;
        }
        
        function handleResizeMove(e) {
            if (!resizeState.windowId) return;
            
            const isTouch = e.type === 'touchmove';
            if (isTouch) e.preventDefault();
            
            const clientX = isTouch ? e.touches[0].clientX : e.clientX;
            const clientY = isTouch ? e.touches[0].clientY : e.clientY;
            
            const win = state.windows.find(w => w.id === resizeState.windowId);
            const dx = clientX - resizeState.startX;
            const dy = clientY - resizeState.startY;
            
            let newWidth = resizeState.startWidth;
            let newHeight = resizeState.startHeight;
            let newLeft = resizeState.startLeft;
            let newTop = resizeState.startTop;
            
            // Minimum sizes
            const minWidth = 300;
            const minHeight = 200;
            
            switch(resizeState.direction) {
                case 'e':
                    newWidth = Math.max(minWidth, resizeState.startWidth + dx);
                    break;
                case 'w':
                    newWidth = Math.max(minWidth, resizeState.startWidth - dx);
                    newLeft = resizeState.startLeft + (resizeState.startWidth - newWidth);
                    break;
                case 's':
                    newHeight = Math.max(minHeight, resizeState.startHeight + dy);
                    break;
                case 'n':
                    newHeight = Math.max(minHeight, resizeState.startHeight - dy);
                    newTop = resizeState.startTop + (resizeState.startHeight - newHeight);
                    break;
                case 'se':
                    newWidth = Math.max(minWidth, resizeState.startWidth + dx);
                    newHeight = Math.max(minHeight, resizeState.startHeight + dy);
                    break;
                case 'sw':
                    newWidth = Math.max(minWidth, resizeState.startWidth - dx);
                    newLeft = resizeState.startLeft + (resizeState.startWidth - newWidth);
                    newHeight = Math.max(minHeight, resizeState.startHeight + dy);
                    break;
                case 'ne':
                    newWidth = Math.max(minWidth, resizeState.startWidth + dx);
                    newHeight = Math.max(minHeight, resizeState.startHeight - dy);
                    newTop = resizeState.startTop + (resizeState.startHeight - newHeight);
                    break;
                case 'nw':
                    newWidth = Math.max(minWidth, resizeState.startWidth - dx);
                    newLeft = resizeState.startLeft + (resizeState.startWidth - newWidth);
                    newHeight = Math.max(minHeight, resizeState.startHeight - dy);
                    newTop = resizeState.startTop + (resizeState.startHeight - newHeight);
                    break;
            }
            
            win.element.style.width = newWidth + 'px';
            win.element.style.height = newHeight + 'px';
            win.element.style.left = newLeft + 'px';
            win.element.style.top = newTop + 'px';
            
            // Update canvas if paint app
            const canvas = document.getElementById(`canvas-${resizeState.windowId}`);
            if (canvas) {
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                canvas.width = newWidth;
                canvas.height = newHeight - 48; // Subtract header height
                ctx.putImageData(imageData, 0, 0);
            }
        }
        
        function handleResizeEnd(e) {
            if (resizeState.windowId) {
                resizeState.windowId = null;
                document.body.style.cursor = '';
            }
        }

        // System Info
        function updateSystemInfo() {
            if ('getBattery' in navigator) {
                navigator.getBattery().then(battery => {
                    const level = Math.round(battery.level * 100);
                    document.getElementById('battery-text').textContent = level + '%';
                    
                    const icon = document.getElementById('battery-icon');
                    if (level < 20) icon.className = 'fas fa-battery-quarter text-hypr-error';
                    else if (level < 50) icon.className = 'fas fa-battery-half text-hypr-warning';
                    else icon.className = 'fas fa-battery-full text-hypr-success';
                });
            }
            
            const cpuUsage = Math.floor(Math.random() * 30) + 5;
            document.getElementById('cpu-text').textContent = cpuUsage + '%';
            
            document.getElementById('volume-level').textContent = state.volume;
            
            const wifiIcon = document.getElementById('wifi-icon');
            if (!navigator.onLine) {
                wifiIcon.className = 'fas fa-wifi-slash text-hypr-error';
            }
        }

        // Search Functions
        function searchWeb() {
            const query = els.globalSearch.value.trim();
            if (query) {
                window.open('https://google.com/search?q=' + encodeURIComponent(query), '_blank');
                els.globalSearch.value = '';
            }
        }

        function searchFiles() {
            const query = els.globalSearch.value.toLowerCase().trim();
            if (!query) return;
            
            const results = [];
            function searchFolder(folder, path) {
                for (const [name, item] of Object.entries(folder.children || {})) {
                    if (name.toLowerCase().includes(query)) {
                        results.push({ name, path: [...path, name], type: item.type });
                    }
                    if (item.type === 'folder') {
                        searchFolder(item, [...path, name]);
                    }
                }
            }
            searchFolder(fileSystem.root, []);
            
            if (results.length > 0) {
                showNotification('Search', `Found ${results.length} result(s)`, 'fa-search');
                if (results[0].type === 'file') {
                    openApp('files', results[0].path.slice(0, -1));
                }
            } else {
                showNotification('Search', 'No results found', 'fa-search');
            }
        }

        // Other Functions
        function toggleLauncher() {
            els.launcher.style.display = els.launcher.style.display === 'none' ? 'flex' : 'none';
            if (els.launcher.style.display === 'flex') {
                document.getElementById('launcher-search').focus();
                renderApps();
            }
        }

        function toggleSettings() {
            els.settingsWindow.classList.toggle('hidden');
        }

        function toggleNetwork() {
            state.wifi = !state.wifi;
            document.getElementById('wifi-icon').className = state.wifi ? 'fas fa-wifi' : 'fas fa-wifi-slash text-hypr-error';
            showNotification('Network', state.wifi ? 'Connected' : 'Disconnected', 'fa-wifi');
        }

        function toggleBluetooth() {
            state.bluetooth = !state.bluetooth;
            document.getElementById('bt-icon').className = state.bluetooth ? 'fab fa-bluetooth-b text-hypr-accent' : 'fab fa-bluetooth-b';
            showNotification('Bluetooth', state.bluetooth ? 'Enabled' : 'Disabled', 'fa-bluetooth-b');
        }

        function toggleBattery() {
            showNotification('Battery', 'Battery info updated', 'fa-battery-half');
        }

        function toggleVolume() {
            const osd = document.createElement('div');
            osd.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 hypr-blur rounded-2xl p-6 z-50 flex flex-col items-center gap-4 window-anim';
            osd.innerHTML = `
                <i class="fas fa-volume-up text-4xl text-hypr-accent"></i>
                <div class="w-48 h-2 bg-hypr-surface rounded-full overflow-hidden">
                    <div class="h-full bg-hypr-accent" style="width: ${state.volume}%"></div>
                </div>
                <span class="text-2xl font-bold">${state.volume}%</span>
            `;
            document.body.appendChild(osd);
            setTimeout(() => osd.remove(), 2000);
        }

        function updateVolume(val) {
            state.volume = val;
            document.getElementById('volume-display').textContent = val + '%';
            
            const icon = document.getElementById('volume-icon');
            if (val == 0) icon.className = 'fas fa-volume-mute text-hypr-error';
            else if (val < 30) icon.className = 'fas fa-volume-low';
            else if (val < 70) icon.className = 'fas fa-volume-down';
            else icon.className = 'fas fa-volume-high';
            
            Object.values(audioPlayers).forEach(player => {
                player.audio.volume = val / 100;
            });
            
            saveState();
        }

        function applyWallpaper() {
            const url = document.getElementById('wallpaper-input').value;
            if (url) {
                state.wallpaper = url;
                els.wallpaper.style.backgroundImage = `url('${url}')`;
                saveState();
                showNotification('Settings', 'Wallpaper updated', 'fa-image');
            }
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.wallpaper = e.target.result;
                    els.wallpaper.style.backgroundImage = `url('${e.target.result}')`;
                    saveState();
                };
                reader.readAsDataURL(file);
            }
        }

        function toggleGlow() {
            state.glow = !state.glow;
            const btn = document.getElementById('glow-toggle-btn');
            const knob = btn.querySelector('div');
            if (state.glow) {
                btn.classList.add('bg-hypr-accent');
                btn.classList.remove('bg-gray-600');
                knob.style.right = '4px';
                knob.style.left = 'auto';
                state.windows.forEach(w => w.element.classList.add('active-glow'));
            } else {
                btn.classList.remove('bg-hypr-accent');
                btn.classList.add('bg-gray-600');
                knob.style.left = '4px';
                knob.style.right = 'auto';
                state.windows.forEach(w => w.element.classList.remove('active-glow'));
            }
            saveState();
        }

        function switchWorkspace(ws) {
            state.activeWorkspace = ws;
            document.querySelectorAll('.workspace').forEach(w => {
                w.classList.remove('active');
                w.classList.add('text-hypr-muted');
                if (parseInt(w.dataset.ws) === ws) {
                    w.classList.add('active');
                    w.classList.remove('text-hypr-muted');
                }
            });
            showNotification('Workspace', `Switched to ${ws}`, 'fa-desktop');
        }

        function showPowerMenu() {
            els.powerMenu.classList.remove('hidden');
        }

        function hidePowerMenu() {
            els.powerMenu.classList.add('hidden');
        }

        function sleepSystem() {
            document.body.style.opacity = '0.1';
            setTimeout(() => {
                document.body.style.opacity = '1';
                hidePowerMenu();
            }, 3000);
        }

        function restartSystem() {
            location.reload();
        }

        function shutdownSystem() {
            document.body.innerHTML = '<div class="h-screen w-screen bg-black flex items-center justify-center text-hypr-muted font-mono">System halted.</div>';
        }

        function resetAll() {
            if (confirm('Reset everything?')) {
                localStorage.removeItem('hypros_complete');
                location.reload();
            }
        }

        function showNotification(title, message, icon, color) {
            const toast = document.createElement('div');
            toast.className = 'toast hypr-blur rounded-lg p-3 flex items-center gap-3 min-w-[250px] pointer-events-auto';
            toast.innerHTML = `
                <i class="fas ${icon} ${color || 'text-hypr-accent'} text-lg"></i>
                <div class="flex-1">
                    <div class="text-sm font-bold">${title}</div>
                    <div class="text-xs text-hypr-muted">${message}</div>
                </div>
            `;
            toast.onclick = () => toast.remove();
            els.notifications.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        function addAppToTaskbar(appIndex) {
            const app = customApps[appIndex];
            if (!app) return;
            
            // Create desktop icon for the app
            const gridSize = 90;
            const iconsPerRow = Math.floor((window.innerWidth - 40) / gridSize);
            
            // Find empty grid position
            let x = 20, y = 20;
            let found = false;
            
            while (!found && y < window.innerHeight - 200) {
                x = 20;
                while (!found && x < window.innerWidth - 100) {
                    const occupied = desktopIcons.some(icon => 
                        Math.abs(icon.x - x) < gridSize/2 && Math.abs(icon.y - y) < gridSize/2
                    );
                    if (!occupied) {
                        found = true;
                        break;
                    }
                    x += gridSize;
                }
                if (!found) y += gridSize;
            }
            
            const iconId = 'customapp_' + Date.now();
            desktopIcons.push({
                id: iconId,
                name: app.name,
                icon: app.icon,
                color: app.color,
                x: x,
                y: y,
                isCustomApp: true,
                appIndex: appIndex
            });
            
            renderDesktopIcons();
            saveState();
            showNotification('App Creator', `Added ${app.name} to desktop`, 'fa-plus');
        }
        
        // Update handleIconDoubleClick to handle custom apps
        function handleIconDoubleClick(e, iconId) {
            e.stopPropagation();
            const icon = desktopIcons.find(i => i.id === iconId);
            
            if (icon.isTrash) {
                openApp('trash');
            } else if (icon.isCustomApp) {
                openApp(`custom_${icon.appIndex}`);
            } else if (icon.path) {
                openApp('files', icon.path);
            }
        }

        // Global Events
        function setupGlobalEvents() {
            document.addEventListener('mousemove', (e) => {
                handleDragMove(e);
                handleResizeMove(e);
            });
            document.addEventListener('mouseup', (e) => {
                handleDragEnd(e);
                handleResizeEnd(e);
            });
            document.addEventListener('touchmove', (e) => {
                handleDragMove(e);
                handleResizeMove(e);
            }, { passive: false });
            document.addEventListener('touchend', (e) => {
                handleDragEnd(e);
                handleResizeEnd(e);
            });
            
            document.addEventListener('mousemove', handleDragMove);
            document.addEventListener('mouseup', handleDragEnd);
            document.addEventListener('touchmove', handleDragMove, { passive: false });
            document.addEventListener('touchend', handleDragEnd);
            
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.context-menu')) hideContextMenu();
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideContextMenu();
                    if (!els.powerMenu.classList.contains('hidden')) hidePowerMenu();
                    else if (els.launcher.style.display !== 'none') toggleLauncher();
                    else if (!els.settingsWindow.classList.contains('hidden')) toggleSettings();
                }
                if (e.altKey && e.key === ' ') {
                    e.preventDefault();
                    toggleLauncher();
                }
            });
            
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.id && node.id.startsWith('win-')) {
                            const windowId = node.id;
                            setTimeout(() => {
                                if (document.getElementById(`canvas-${windowId}`)) {
                                    initPaint(windowId);
                                }
                                if (document.getElementById(`playlist-${windowId}`)) {
                                    updatePlaylist(windowId);
                                }
                            }, 100);
                        }
                    });
                });
            });
            observer.observe(els.windowsContainer, { childList: true });
            
            document.getElementById('desktop-area').addEventListener('click', (e) => {
                if (e.target.id === 'desktop-area' || e.target.id === 'wallpaper') {
                    document.querySelectorAll('.desktop-icon').forEach(el => el.classList.remove('selected'));
                }
            });
        }

        // Initialize
        init();

    </script>
</body>

</html>
